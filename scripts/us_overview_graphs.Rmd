---
title: "US overview  slides"
author: "Tourism Economics"
date: "Insert date"
output:
  ioslides_presentation:
    fig_height: 5.7
    fig_retina: null
    fig_width: 9
    smaller: yes
  beamer_presentation: default
  slidy_presentation: default
---

## Contents

- Bullet 1
- Bullet 2
- Bullet 3

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
require(directlabels)
require(rmarkdown)
require(knitr)
require(RColorBrewer)
require(gridExtra)
require(gtable)
require(Cairo)

# If I put autodep=TRUE as an argument in the following then I get
# some issues with the graphs, such as grey backgrounds and changes
# in labeling. Maybe it somehow impacts the theme?
#knitr::opts_chunk$set(cache=TRUE, cache.path='output_data/cache/', dpi=96)
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, cache.path='../output_data/cache/', autodep=TRUE, fig.path='../output_data/figure_us_overview_graphs/fig-', dev='CairoPNG', out.width='9in', out.height='5.7in', fig.width=9, fig.height=5.7, dpi=400)


```

```{r readchunk}
read_chunk('~/Project/R projects/lodfor/scripts/functions.R')
source('~/Project/R projects/lodfor/scripts/functions.R')
```

```{r load_files}
fpath <- c("~/Project/R projects/lodfor/")

# when kniting from the button, I either needed the full path or to add "../" 
# in front of each
load(paste(fpath, "output_data/ushist_m.Rdata", sep=""))
load(paste(fpath, "output_data/outf_str_us_m.Rdata", sep=""))
load(paste(fpath, "output_data/ushist_q.Rdata", sep=""))
load(paste(fpath, "output_data/usfor_q.Rdata", sep=""))
load(paste(fpath, "output_data/recession_df_m.Rdata", sep=""))
load(paste(fpath, "output_data/top25compile.Rdata", sep=""))
```

```{r create_dataframes}
# puts the monthly str data into a melted data frame
ushist_m_m <- ushist_m %>%
  window(end = as.Date("2015-12-01")) %>%
  data.frame(date=index(.),.) %>%
  melt(id.vars = c("date"))
# I used to have a version of ushist_m as a dataframe, but I'm not sure
# I need it, so I've stopped creating it and left ushist_m as an xts object

# puts the monthly simple forecast data into a melted data frame
outf_str_us_m_m <- outf_str_us_m %>%
  window(end = as.Date("2014-09-01")) %>%
  data.frame(date=index(.),.) %>%
  melt(id.vars = c("date"))

# puts the quarterly ushist into a melted data frame
ushist_q_m <- ushist_q %>%
  window(end = as.Date("2017-10-01")) %>%
  data.frame(date=index(.), .) %>%
  melt(id.vars = c("date"))

# this is in an actual tidy format with date and seg columns to describe the
# observations, and then variables in the columns
ushist_q_td <- data.frame(date=time(ushist_q), ushist_q)%>%
    melt(id.vars = c("date")) %>%
  separate(variable, c("seg", "var"), sep = "_", extra="merge") %>%
  spread(var, value)

# this is a vestige of an earlier approach
# select(-year,-month,-qtr,-days) %>%
#   gather(segvar, value, -date, na.rm = FALSE) %>%
#   # I had difficulty separating by the underscore
#   # because there are more than one underscore in some
#   # so my solution was to mutate the column, applying 
#   # the sub function, which replaces the first occurance of
#   # the underscore with a period
#   mutate(segvar = sub("_",".", segvar)) %>%
#   # then run the separate on the period, using backslashes
#   # to escape out of the second character
#   separate(segvar, c("seg", "variable"), sep = "\\.") 

# this is in an actual tidy format with date and seg columns to describe the
# observations, and then variables in the columns
usfor_q_td <- data.frame(date=time(usfor_q), usfor_q)%>%
  melt(id.vars = c("date")) %>%
  separate(variable, c("seg", "var"), sep = "_", extra="merge") %>%
  spread(var, value)

# this is in an actual tidy format with date and seg columns to describe the
# observations, and then variables in the columns
top25compile_td <- top25compile %>%
  melt(id.vars = c("date")) %>%
  separate(variable, c("seg", "var"), sep = "_", extra="merge") %>%
  spread(var, value)
  # filter to just top25us 
  #filter(seg == "top25us")

```

```{r create_forecastdataframe}
# appends history onto the forecast dataframe
# only adds the columns that are in both data frames
# a bit of a tortured approach
e1 <- ushist_q %>%
  window(end = as.Date("2004-10-01")) %>%
  data.frame(date=index(.),.) 

str(usfor_q)
f1 <- usfor_q %>%
   window(start = as.Date("2005-01-01")) %>%
  data.frame(date=index(.),.) 

# In Feb 2015 I was temporarily brining in penwall, which was in 
# ushist_q but not usfor_q
temppenwall <- ushist_q$us_penwall
temppenwall <- temppenwall %>%
   window(start = as.Date("2005-01-01")) %>%
  data.frame(date=index(.),.) 
f1 <- merge(f1,temppenwall,by="date")

e2 <- e1[, which(names(e1) %in% colnames(f1))]
f2 <- f1[, which(names(f1) %in% colnames(e1))]

usfor_q <- rbind(e2,f2)
usfor_q <- usfor_q %>%
    read.zoo() %>%
  xts()

# calculates some real series using the data in usfor_q
# first index the personal cons price deflator to average 100 in 2014
us_pc_index <- index_q(ushist_q$us_pc, index_year=2014)
names(us_pc_index) <- "us_pc_index"
usfor_q <- merge(usfor_q, us_pc_index)

# select the series that contain adr or revpar and convert to real
# the way this works is that matches works on a regular expression
# I wrote a regular expression that is taking _adr_ or _revpar_
# for reference on writing regular expressions, see
# http://www.regular-expressions.info/quickstart.html
real_df <- data.frame(usfor_q) %>%
  select(matches("_adr$|_adr_sa|_revpar$|_revpar_sa|us_penwall")) %>% 
  mutate_each(funs(ind = ( . / us_pc_index)*100))
# adds on a time index to get it back to xts
temp <- data.frame(date=time(usfor_q)) 
real_df <- cbind(temp,real_df)
real <- read.zoo(real_df)
real <- xts(real)

# renames series 
tempnames <- names(real)
tempnames <- paste(tempnames,"rpc",sep="")
names(real) <- tempnames
rm(tempnames)
# merges onto ushist_q
usfor_q <- merge(usfor_q, real)
#autoplot(window(usfor_q$ecous_adr_sarpc, start="2000-01-01", end="2014-10-01"))

# then melts the dataframe
usfor_q_m <- usfor_q %>%
  window(end = as.Date("2017-10-01")) %>%
  data.frame(date=index(.), .) %>%
  melt(id.vars = c("date"))
```

```{r load_code_book_matrix}
#Loads code_book_matrix and shows example contents
fname <- c(paste("~/Project/R projects/lodfor/input_data/code_book_matrix.csv", sep=""))
code_book_matrix <- read.csv(fname, stringsAsFactors=FALSE)
rm(fname)
```

```{r define_theme}
#Displays palette and sets the ts1 theme

#display.brewer.pal(10, "RdBu")
mypallete <- brewer.pal( 10 , "RdBu" )
colors_ts1 <- scale_colour_manual(values = mypallete[c(10, 1, 5, 4)])
# I don't use the following, was an example I saw somewhere maybe as a way to 
# interpolate additional palette colors
#mypal <- colorRampPalette( brewer.pal( 10 , "RdBu" ) )
theme_ts1 <- function (base_size = 12, base_family = "") {
  theme_classic(base_size = base_size, base_family = base_family) %+replace%
    theme(                                 
      panel.grid.major.x=element_blank(),
      panel.grid.minor.x=element_blank(),
      panel.grid.minor.y=element_blank(),
      axis.ticks.y=element_line(size=.2),
      axis.ticks.x=element_line(size=.2),
      panel.background=element_blank(),
      legend.title=element_blank(),
      legend.key=element_rect(fill="white", colour = "white"),
      legend.key.size=unit(1, "cm"),
      legend.text=element_text(size=rel(1)),
      legend.position = c(1, .1),
      legend.position = "none",
      legend.justification = "right",
      axis.line=element_line(size=.2),
      axis.title.y=element_blank(),
      axis.title.x=element_blank(),
      axis.text=element_text(color="black",size=rel(.7)),
      # following seems to adjust y-axis title
      plot.title=element_text(size=base_size * .8, face="plain",hjust=0,vjust=1)
    #theme(plot.title = element_text(lineheight=.8, face="bold"))
    )
}
```

```{r set_theme}
theme_set(theme_ts1())
#this is also a useful theme to keep in mind
#theme_classic()
# this function gets the settings used by the current theme
#theme_get()
```

## Demand, monthly + GDP 
```{r demand_monthly_gdp}
#sets variable and text items
todo <- c("totus_demd_sa")
grtitle <- c("US room demand and GDP")
footnote <- c("Note: Seasonally adjusted. GDP quarterly. Room demand monthly through May 2015.\nSource: STR, Tourism Economics")
starta <- as.Date("2004-01-01")
enda <- as.Date("2015-10-01")
index_year <- as.numeric(2006)
variable_text <- c(paste("Index (",index_year,"=100)",sep=""))
variable_legend_1 <- c("Room demand")
variable_legend_2 <- c("GDP")

# filters and uses function to convert to index
temp <- ushist_m_m %>%
  filter(variable == todo, date >= starta, date <= enda) %>%
  index_m_melted(index_year=index_year)
temp2 <- ushist_q_m %>%
  filter(variable == "us_gdp", date >= starta, date <= enda) %>%
  index_q_melted(index_year=index_year)

p1 <- ggplot() +
  geom_line(data = temp, aes(x = date, y = value, color=variable), size = .7) + 
  geom_line(data = temp2, aes(x = date, y = value, color=variable), size = .8) +
  ggtitle(variable_text) +
  theme(legend.position=c(1, .2)) +
  scale_x_date(breaks = "1 year", labels = date_format("%Y")) +
  stat_smooth(data = temp, aes(x = date, y = value), method="loess", 
              color=mypallete[9:9], alpha=.4, span=.2, se = FALSE, fullrange=FALSE, size=.9, show_guide=FALSE) +
  scale_color_manual(values = c(mypallete[7:7], "grey40", "grey40"),  labels=c(variable_legend_1,variable_legend_2, "text"))
p1

plot_title_3(plot=p1, grtitle=grtitle, footnote=footnote)


# png(filename=paste(fpath_graphs,"demand_gdp.png",sep=""),
#      type="cairo",
#      units="in", 
#      width=9, 
#      height=5.7, 
#      pointsize=10, 
#      res=800)
# plot_title_3(plot=p1, grtitle=grtitle, footnote=footnote)
# dev.off()

# take a look at GDP growth rate as a check
#a <- ushist_q$us_gdp
#a$us_gdp_cagr <- ((a$us_gdp/lag(a$us_gdp,1))^4-1)
#window(a, start=as.Date("2013-01-01"), end=as.Date("2015-01-01"))
```

## Demand and GDP with forecast 
```{r demand_gdp_forecast}
#sets variable and text items
todo <- c("totus_demd_sa")
grtitle <- c("US room demand and GDP")
footnote <- c("Note: Seasonally adjusted, quarterly. Historical room demand through first quarter 2015. \nSource: STR, Tourism Economics")
starta <- as.Date("2004-01-01")
endhistory <- as.Date("2015-01-01")
startforecast <- as.Date("2015-01-01")
enda <- as.Date("2016-10-01")
index_year <- as.numeric(2006)
variable_text <- c(paste("Index (",index_year,"=100)",sep=""))

# filters and uses function to convert to index
temp <- usfor_q_m %>%
  filter(variable == todo) %>%
  index_m_melted(index_year=index_year) %>%
  filter(date >= starta, date <= endhistory) 

temp2 <- usfor_q_m %>%
  filter(variable == todo) %>%
  index_m_melted(index_year=index_year) %>%
  filter(date >= startforecast, date <= enda) 

temp3 <- usfor_q_m %>%
  filter(variable == "us_gdp") %>%
  index_q_melted(index_year=index_year) %>%
  filter(date >= starta, date <= enda) 

temp4 <- rbind(temp, temp3)
# temp5 <- subset(recession_df_m, start_rec >= min(temp4$date))
#   geom_line(data = temp[temp$date<=as.Date("2014-10-01"),], 
#             aes(x = date, y = value), color=mypallete[10:10], size=.9) + 
#     geom_line(data = temp[temp$date>=as.Date("2014-10-01"),], 
#             aes(x = date, y = value), color=mypallete[10:10],  size=.9, linetype = "99") +
# #   geom_line(data = temp[temp$date>=as.Date("2014-10-01"),], 
# #             aes(x = date, y = value), color=mypallete[10:10], size=.5) +
# #     geom_point(data = temp[temp$date>=as.Date("2014-10-01"),], 
# #             aes(x = date, y = value), color=mypallete[10:10], pch=1, cex=2) +
#     geom_line(data = temp[temp$date<=as.Date("2014-10-01"),], 
#             aes(x = date, y = value_max), color="grey40") +
# p1 <- ggplot(temp4, aes(x = date, y = value, color=variable)) +
#   geom_line(size=.8)  +
#   scale_color_manual(values = setNames(c(mypallete[10:10], "grey60"), c(todo, "us_gdp")), 
#                      labels=c("Room demand", "GDP")) +
#   geom_line(data=temp2, aes(x = date, y = value), size=.8, linetype="99") +
#     theme(legend.position = c(1, .2)) 
# p1
# 
# 

p1 <- ggplot() +
  geom_line(data=temp4, aes(x = date, y = value, color=variable), size=.8)  +
  scale_color_manual(values = setNames(c(mypallete[10:10], "grey60"), c(todo, "us_gdp")), 
                     labels=c("Room demand", "GDP")) +
  geom_line(data=temp2, aes(x = date, y = value), size=.8, 
            color = mypallete[10:10], linetype="99") +
    theme(legend.position = c(1, .2)) +  
  geom_rect(data=subset(recession_df_m, start_rec >= min(temp4$date)), #trims length
            aes(xmin=start_rec
                ,xmax=end_rec
                ,ymin=-Inf  # to bottom of graph
                ,ymax=Inf), # to top of graph
                fill="grey40", alpha=0.2)
plot_title_3(plot=p1, grtitle=grtitle, footnote=footnote)
# a <- recordPlot()
# replayPlot(a)
#print(plot_title_3(plot=p1, grtitle=grtitle, footnote=footnote))
# save image
# png(filename=paste(fpath_graphs,"demand_gdp_forecast.png",sep=""), 
#      type="cairo",
#      units="in", 
#      width=9, 
#      height=5.7, 
#      pointsize=10, 
#      res=800)
# plot_title_3(plot=p1, grtitle=grtitle, footnote=footnote)
# dev.off()

# take a look at GDP growth rate as a check
# a <- usfor_q$us_gdp
# head(a)
# a$us_gdp_cagr <- ((a$us_gdp/lag(a$us_gdp,1))^4-1)
# window(a, start=as.Date("2013-01-01"), end=as.Date("2015-01-01"))
```


## Demand, ratio to population 
```{r demand_ratio_pop}
#sets variable and text items
#todo <- c("totus_demd_sa")
grtitle <- c("Room demand per capita")
footnote <- c("Source: STR; Census Bureau; Tourism Economics")
starta <- as.Date("1987-01-01")
enda <- as.Date("2015-10-01")
variable_text <- c("Annual room nights per capita \n(working age population)")
variable_legend_1 <- c("Room demand")

temp <- ushist_q_m %>% 
  filter(variable == "totus_demd_sa" | variable == "us_popw", date >= starta, date <= enda) %>%
  spread(variable, value) %>%
  mutate(dem_popw = totus_demd_sa * 365 / us_popw*1000) %>%
  select(date, dem_popw) %>%
  melt(id.vars = c("date"))

p1 <- ggplot() +
  geom_line(data = temp, aes(x = date, y = value, color = variable), size = .7) +
 ggtitle(variable_text) + 
  scale_color_manual(values = c(mypallete[10:10], "grey70")) +
  stat_smooth(data = temp, aes(x = date, y = value), method=lm, fill = "grey90", color="grey40", alpha=.4, span=.7, se = FALSE)
p1
plot_title_3(plot=p1, grtitle=grtitle, footnote=footnote)
```

## Demand, ratio to employment 
```{r demand_ratio_emp}
#sets variable and text items
#todo <- c("totus_demd_sa")
grtitle <- c("Room demand as ratio to total employment")
footnote <- c("Note: Data through first quarter 2015. Household survey employment. \nSource: STR; Bureau of Labor Statistics; Tourism Economics")
starta <- as.Date("1987-01-01")
enda <- as.Date("2015-10-01")
variable_text <- c("Annual room nights per employed person")
variable_legend_1 <- c("Room demand")

temp <- ushist_q_m %>% 
  filter(variable == "totus_demd_sa" | variable == "us_et", date >= starta, date <= enda) %>%
  spread(variable, value) %>%
  mutate(dem_et = totus_demd_sa * 365 / us_et*1000) %>%
  select(date, dem_et) %>%
  melt(id.vars = c("date"))

p1 <- ggplot() +
  geom_line(data = temp, aes(x = date, y = value, color = variable), size = .7) +
 ggtitle(variable_text) + 
 scale_x_date(breaks = "1 year", labels = date_format("%y")) +
 scale_color_manual(values = c(mypallete[10:10], "grey70")) +
 stat_smooth(data = temp, aes(x = date, y = value), method=lm, fill = "grey90", color="grey40", alpha=.4, span=1, se = FALSE)
plot_title_3(plot=p1, grtitle=grtitle, footnote=footnote)
```

## Occupancy labled
```{r occupancy_labled}
#sets variable and text items
todo <- c("totus_occ_sa")
grtitle <- c("Occupancy")

footnote <- c("Source: STR; Tourism Economics")
start_mean <- as.Date("2002-01-01") # for mean

start_xaxis <- as.Date("1995-01-01") # for x-axis
end_xaxis <- as.Date(max(temp$date)) # for x-axis
variable_text <- c("Seasonally adjusted, quarterly")
note <- paste("Average", year(start_mean), "to", year(end_xaxis), sep=" ")
#variable_legend_1 <- c("Text")

temp <- ushist_q_m %>% 
  filter(variable == todo, !is.na(value)) %>%
  group_by(variable) %>% 
  mutate(value_mean=mean(value)) %>%
  # gather is tidyr version of melt, creates measure and value columns, 
  # in a sense by gathering value to value_mean columns
  gather(measure, value, value:value_mean)
levels(temp$measure)[levels(temp$measure)=="value"] <- "Occupancy"
levels(temp$measure)[levels(temp$measure)=="value_mean"] <- "Average"

p1 <- ggplot(data = temp, aes(x = date, y=value, color = measure)) +
  geom_line(aes(group = measure)) + 
  coord_cartesian(xlim = c(start_xaxis, end_xaxis)) +
    scale_y_continuous(labels=percent) +
    ggtitle(variable_text) +
  scale_color_manual(values = c(mypallete[10:10], "grey60")) 
p1 <- direct.label (p1,
list ("lines2" , hjust = 0 , vjust = 1 , cex = 1 ))
plot_title_3(plot=p1, grtitle=grtitle, footnote=footnote)

# direct.label(p,"lines2")
# direct.label(p,"first.qp")
# direct.label(p,"last.bumpup")
# direct.label(p,"last.qp", cex=2)
# direct.label(p,"maxvar.qp", cex=2)  
```

## Occupancy with forecast
```{r occupancy_forecast}
#sets variable and text items
todo <- c("totus_occ_sa")
grtitle <- c("Occupancy")

footnote <- c("Note: Seasonally adjusted. History through first quarter 2015, forecast through fourth quarter 2017.\nSource: STR; Tourism Economics")
start_mean <- as.Date("2000-01-01") # for mean
end_mean <- as.Date("2014-10-01")
start_xaxis <- as.Date("1995-01-01") # for x-axis
variable_text <- c("")
note <- paste("Average", year(start_mean), "to", year(end_xaxis), sep=" ")
#variable_legend_1 <- c("Text")

# calculates mean over selected period
holdmean <- usfor_q_m %>% 
  filter(variable == todo, !is.na(value), date >= start_mean, date <= end_mean) 
holdmean <- mean(holdmean$value, na.rm=TRUE)

temp <- usfor_q_m %>% 
  filter(variable == todo, !is.na(value)) 
end_xaxis <- as.Date(max(temp$date)) # needs to happen after series is in temp

p1 <- ggplot(temp, aes(x = date, y=value)) +
  geom_line(data = temp[temp$date<=as.Date("2015-01-01"),], color=mypallete[10:10], size=.8) + 
  geom_line(data = temp[temp$date>=as.Date("2015-04-01"),], color=mypallete[10:10], size=.8, linetype="99") +
  geom_hline(aes(yintercept=holdmean), color="grey60") +
  ggtitle(variable_text) +
  coord_cartesian(xlim = c(start_xaxis, end_xaxis)) +
  scale_y_continuous(labels=percent) +
  annotate("text", x = as.Date("1998-01-01"), y = holdmean+.006, size=3,
        label = c(paste("Long-term average: ",sprintf("%.1f%%", holdmean*100), "\n(2000 to 2014)",sep="")))
plot_title_3(plot=p1, grtitle=grtitle, footnote=footnote)
 
```


##Following graphs are based on code from around the STR presentation in November

## ADR, real long-term
```{r adr_real_lt}
todo <- c("totus_adr_sarpc")
grtitle <- c("Real ADR, US")
footnote <- c("Source: STR; Bureau of Economic Analysis; Tourism Economics")
starta <- as.Date("1987-01-01")
enda <- as.Date("2015-04-01")
variable_text <- c("Seasonally adjusted")

temp <- ushist_q_m %>% 
  filter(date >= starta, date <= enda, variable == todo) %>%
  spread(variable, value) %>%
  melt(id.vars = c("date"))%>%
  mutate(group_date = cut(date, breaks = as.Date(c("1987-01-01", "1998-01-01","2015-01-01"))))

p1 <- ggplot(data = temp, aes(x = date, y = value, color = variable, shape = factor(group_date))) +
  geom_line(aes(x= date, y=value, group=1), size = .8) +
  ggtitle(variable_text) + 
  scale_color_manual(values = c(mypallete[10:10], "grey40")) +
  stat_smooth(method="lm", fill = "grey60", 
              color="grey60", span=.7, se = FALSE)+ 
  scale_y_continuous(labels = dollar)
plot_title_3(plot=p1, grtitle=grtitle, footnote=footnote)
```


## ADR, real medium-term
```{r adr_real_mt}
todo <- c("totus_adr_sarpc")
grtitle <- c("Real ADR, US")
footnote <- c("Note: Seasonally adjusted.\nSource: STR; Bureau of Economic Analysis; Tourism Economics")
starta <- as.Date("2001-01-01")
enda <- as.Date("2015-10-01")
variable_text <- c("")

temp <- ushist_q_m %>% 
  filter(date >= starta, date <= enda, variable == todo) %>%
  spread(variable, value) %>%
  melt(id.vars = c("date"))

p1 <- ggplot() +
  geom_line(data = temp, aes(x = date, y = value, color = variable), size = .8) +
 ggtitle(variable_text) + 
scale_color_manual(values = c(mypallete[10:10], "grey60")) + 
  scale_y_continuous(labels = dollar)
plot_title_3(plot=p1, grtitle=grtitle, footnote=footnote)
```

## ADR, real short-term
```{r adr_real_st}
todo <- c("totus_adr_sarpc")
grtitle <- c("Real ADR, US")
footnote <- c("Note: Seasonally adjusted.Historical data through first quarter of 2015. \nSource: STR; Bureau of Economic Analysis; Tourism Economics")
starta <- as.Date("2006-01-01")
enda <- as.Date("2015-10-01")
variable_text <- c("")

temp <- ushist_q_m %>% 
  filter(date >= starta, date <= enda, variable == todo) %>%
  spread(variable, value) %>%
  melt(id.vars = c("date")) %>%
  mutate(group_date = cut(date, breaks = as.Date(c("2004-01-01", "2008-04-01", "2010-01-01","2015-10-01"))))

p1 <- ggplot(data = temp, aes(x = date, y = value, shape = factor(group_date))) + 
 geom_line(aes(x= date, y=value, group=1), size = .8, color=mypallete[10:10]) +
 ggtitle(variable_text) + 
 scale_color_manual(values = c(mypallete[10:10], "grey60"))  + 
 geom_line(stat="smooth", method="lm",
              color="grey60", size=.6, alpha=.8, span=.7, se = FALSE) +
  scale_y_continuous(labels = dollar)
plot_title_3(plot=p1, grtitle=grtitle, footnote=footnote)
```

## ADR, short-term
```{r adr_st}
todo <- c("totus_adr_sa")
grtitle <- c("ADR, US")
footnote <- c("Note: Seasonally adjusted.\nSource: STR; Bureau of Economic Analysis; Tourism Economics")
starta <- as.Date("2006-01-01")
enda <- as.Date("2015-10-01")
variable_text <- c("")

temp <- ushist_q_m %>% 
  filter(date >= starta, date <= enda, variable == todo) %>%
  spread(variable, value) %>%
  melt(id.vars = c("date")) %>%
  mutate(group_date = cut(date, breaks = as.Date(c("2004-01-01", "2008-04-01", "2010-01-01","2015-10-01"))))

p1 <- ggplot(data = temp, aes(x = date, y = value, shape = factor(group_date))) + 
 geom_line(aes(x= date, y=value, group=1), size = .7, color=mypallete[10:10]) +
 ggtitle(variable_text) + 
 scale_color_manual(values = c(mypallete[10:10], "grey60"))  +
    geom_line(stat="smooth", method="lm",
              color="grey60", size=.6, alpha=.8, span=.7, se = FALSE) +
  scale_y_continuous(labels = dollar)
plot_title_3(plot=p1, grtitle=grtitle, footnote=footnote)
```


## ADR, short-term, monthly
```{r adr_st_monthly}
todo <- c("totus_adr_sa")
grtitle <- c("ADR, monthly, US")
footnote <- c("Note: Seasonally adjusted.Historical data through May 2015. \nSource: STR; Bureau of Economic Analysis; Tourism Economics")
starta <- as.Date("2006-01-01")
enda <- as.Date("2015-10-01")
variable_text <- c("")

temp <- ushist_m_m %>% 
  filter(date >= starta, date <= enda, variable == todo) %>%
  spread(variable, value) %>%
  melt(id.vars = c("date")) %>%
  mutate(group_date = cut(date, breaks = as.Date(c("2004-01-01", "2008-04-01", "2010-01-01","2015-10-01"))))

p1 <- ggplot(data = temp, aes(x = date, y = value, shape = factor(group_date))) + 
 geom_line(aes(x= date, y=value, group=1), size = .7, color=mypallete[10:10]) +
 ggtitle(variable_text) + 
geom_line(stat="smooth", method="lm",
              color="grey60", size=.6, alpha=.8, span=.7, se = FALSE) +
  scale_y_continuous(labels = dollar)
plot_title_3(plot=p1, grtitle=grtitle, footnote=footnote)

#write.csv(temp, file="output_data/temp.csv", row.names=FALSE)
```


## ADR, short-term with forecast
```{r adr_st_forecast}
todo <- c("totus_adr_sa")
grtitle <- c("ADR, US")
footnote <- c("Note: Seasonally adjusted. History through first quarter of 2015. Forecast through fourth quarter of 2016.\nSource: STR; Tourism Economics")
starta <- as.Date("2004-01-01")
enda <- as.Date("2016-10-01")
variable_text <- c("")

temp <- usfor_q_m %>% 
  filter(date >= starta, date <= enda, variable == todo) %>%
  spread(variable, value) %>%
  melt(id.vars = c("date")) %>%
  mutate(group_date = cut(date, breaks = as.Date(c("2000-01-01", "2008-04-01", "2010-01-01","2017-01-01"))))

p1 <- ggplot(data = temp, aes(x = date, y = value, shape = factor(group_date))) + 
 geom_line(data = temp[temp$date<=as.Date("2015-01-01"),], aes(x= date, y=value, group=1), size = .8, color=mypallete[10:10]) +
geom_line(data = temp[temp$date>=as.Date("2015-04-01"),], aes(x= date, y=value, group=1), color=mypallete[10:10], size=.9, lty="99") +
 ggtitle(variable_text) + 
 scale_color_manual(values = c(mypallete[10:10], "grey60"))  + 
 stat_smooth(method="lm", fill = "grey70", 
             color="grey60", alpha=.4, span=.8, se = FALSE)+ 
  scale_y_continuous(labels = dollar)
plot_title_3(plot=p1, grtitle=grtitle, footnote=footnote)
```


## ADR, growth, short-term 
```{r adr_gr_st}
#sets variable and text items
 
todo <- c("totus_adr_sa")
grtitle <- c("ADR, US")
footnote <- c("Note: Seasonally adjusted.\nSource: STR; Tourism Economics")
 
# starta <- as.Date("2008-01-01")
# enda <- as.Date("2015-01-01")
variable_text <- c("")
 
temp <- ushist_q_m %>% 
  filter(variable == todo) %>%
  spread(variable, value) %>%
  melt(id.vars = c("date")) %>%
  select(-variable) %>%
  mutate(group_date = cut(date, breaks = as.Date(c("2004-01-01", "2008-01-01", "2009-10-01","2015-10-01")))) %>%
  mutate(cagr = (value / lag(value))^4 -1, pchya = (value/lag(value, 4)) -1) %>%
  select(-value) %>%
 # filter(date >= starta, date <= enda) %>%
  melt(id.vars = c("date", "group_date")) %>%
  transform(value = as.numeric(value))

start_xaxis <- as.Date("2008-01-01") # for x-axis
end_xaxis <- as.Date("2015-10-01") # for x-axis
p1 <- ggplot(data = temp, aes(x = date, y = value, group=variable)) + 
 geom_line(size = .7, color=mypallete[10:10]) +
  geom_point() +
 ggtitle(variable_text) + 
 scale_color_manual(values = c(mypallete[10:10], "grey60"))  + 
 stat_smooth(method="loess", fill = "grey90", 
             color="grey60", alpha=.4, span=.8, se = TRUE) +
 scale_y_continuous(labels = percent)  + 
    coord_cartesian(xlim = c(start_xaxis, end_xaxis)) +
 facet_wrap(~ variable, ncol=1, scales = "free")+
# doesn't add minor tick marks, just for grid I guess 
 scale_x_date(labels = date_format("%Y"), breaks = "1 year", minor_breaks = "3 months") 
# useful
#http://stackoverflow.com/questions/10151123/how-to-specify-columns-in-facet-grid-or-how-to-change-labels-in-facet-wrap
plot_title_3(plot=p1, grtitle=grtitle, footnote=footnote)
```


## ADR, growth cagr, short-term 
```{r adr_gr_cagr_st}
#sets variable and text items
 
todo <- c("totus_adr_sa")
grtitle <- c("ADR, US")
footnote <- c("Source: STR; Tourism Economics")
variable_text <- c("Seasonally adjusted, compound annual growth rate")
 
temp <- ushist_q_m %>% 
  filter(variable == todo) %>%
  spread(variable, value) %>%
  melt(id.vars = c("date")) %>%
  select(-variable) %>%
#  mutate(group_date = cut(date, breaks = as.Date(c("2004-01-01", "2008-01-01", "2009-10-01","2015-01-01")))) %>%
  mutate(cagr = (value / lag(value))^4 -1) %>%
  select(-value) %>%
 # filter(date >= starta, date <= enda) %>%
  melt(id.vars = c("date")) %>%
  transform(value = as.numeric(value))

start_xaxis <- as.Date("2003-01-01") # for x-axis
end_xaxis <- as.Date("2015-10-01") # for x-axis
p1 <- ggplot(data = temp, aes(x = date, y = value, group=variable)) + 
 geom_line(size = .7, color=mypallete[10:10]) +
  geom_point() +
 ggtitle(variable_text) + 
 scale_color_manual(values = c(mypallete[10:10], "grey60"))  + 
 stat_smooth(method="loess", fill = "grey90", 
             color="grey40", alpha=.4, span=.25, se = TRUE) +
 scale_y_continuous(labels = percent)  + 
    coord_cartesian(xlim = c(start_xaxis, end_xaxis), ylim = c(-.1,.1)) +
# facet_wrap(~ variable, ncol=1, scales = "free")+
# doesn't add minor tick marks, just for grid I guess 
 scale_x_date(labels = date_format("%Y"), breaks = "1 year", minor_breaks = "3 months") 
# useful
#http://stackoverflow.com/questions/10151123/how-to-specify-columns-in-facet-grid-or-how-to-change-labels-in-facet-wrap
plot_title_3(plot=p1, grtitle=grtitle, footnote=footnote)

```

## RevPAR, real long-term
```{r revpar_real_lt}
#sets variable and text items
todo <- c("totus_revpar_sarpc")
grtitle <- c("Real RevPAR, US")
footnote <- c("Note: Seasonally adjusted, 2014 dollars.\nSource: STR; Bureau of Economic Analysis; Tourism Economics")
starta <- as.Date("1987-01-01")
enda <- as.Date("2015-10-01")
variable_text <- c("")

temp <- ushist_q_m %>% 
  filter(date >= starta, date <= enda, variable == todo) %>%
  spread(variable, value) %>%
  melt(id.vars = c("date"))

# calculating mean from a certain date forward
holdmean <- temp %>%
  filter(date >= as.Date("2000-01-01"), date <= as.Date("2014-10-01") )
holdmean <- mean(holdmean$value, na.rm=TRUE)

p1 <- ggplot() +
 geom_line(data = temp, aes(x = date, y = value, color = variable), size = .7) +
 ggtitle(variable_text) + 
 scale_color_manual(values = c(mypallete[10:10], "grey60")) +
 geom_hline(yintercept = holdmean, colour = "grey60", size = 0.5) +
 annotate("text", x = as.Date("1988-01-01"), y = holdmean+1.5, size=3,
         label = c(paste("Long-term average:\n$",sprintf("%.2f", holdmean), " (2000 to 2014)",sep="")))+ 
  scale_y_continuous(labels = dollar, limits=c(50,80))
p1 <- p1 + geom_rect(data=subset(recession_df_m, start_rec >= min(temp$date)), #trims length
            aes(xmin=start_rec
                ,xmax=end_rec
                ,ymin=-Inf  # to bottom of graph
                ,ymax=Inf), # to top of graph
                 fill="grey40", alpha=0.2)
plot_title_3(plot=p1, grtitle=grtitle, footnote=footnote)
```


## RevPAR, real long-term, with forecast
```{r revpar_real_lt_fcst}
#sets variable and text items
todo <- c("totus_revpar_sarpc")
grtitle <- c("Real RevPAR, US")
footnote <- c("Note: Seasonally adjusted. History through the first quarter of 2015. Forecast through the fourth quarter of 2017.\nSource: STR; Bureau of Economic Analysis; Tourism Economics")
starta <- as.Date("1987-01-01")
enda <- as.Date("2017-10-01")
variable_text <- c("")

temp <- usfor_q_m %>% 
  filter(date >= starta, date <= enda, variable == todo) %>%
  spread(variable, value) %>%
  melt(id.vars = c("date"))

# calculating mean from a certain date forward
holdmean <- temp %>%
  filter(date >= as.Date("2000-01-01"), date <= as.Date("2014-10-01") )
holdmean <- mean(holdmean$value, na.rm=TRUE)

p1 <- ggplot() +
   geom_line(data = temp[temp$date<=as.Date("2015-01-01"),], 
             aes(x = date, y = value), color=mypallete[10:10], size=.9) + 
   geom_line(data = temp[temp$date>=as.Date("2015-04-01"),], 
             aes(x = date, y = value), color=mypallete[10:10], size=.9, linetype = "99") +
   geom_hline(yintercept = holdmean, colour = "grey60", size = 0.7) + 
   ggtitle(variable_text) + 
   scale_color_manual(values = c(mypallete[10:10], "grey60")) +
   annotate("text", x = as.Date("1988-01-01"), y = holdmean+1.9, size=3,
         label = c(paste("Long-term average:\n$",sprintf("%.2f", holdmean), " (2000 to 2014)",sep="")))+ 
   scale_y_continuous(labels = dollar, limits=c(40,85))
p1 <- p1 +
geom_rect(data=subset(recession_df_m, start_rec >= min(temp$date)), #trims length
            aes(xmin=start_rec
                ,xmax=end_rec
                ,ymin=-Inf  # to bottom of graph
                ,ymax=Inf), # to top of graph
                fill="grey40", alpha=0.2)
plot_title_3(plot=p1, grtitle=grtitle, footnote=footnote)

```



## RevPAR, real long-term - by scale
```{r revpar_real_lt_Scale}
#sets variable and text items
todovar <- c("revpar_sarpc")
todo <- c("totus", "Total US")
todo2 <- c("upuus", "Upper upscale")

grtitle <- c("Real RevPAR")
footnote <- c("Note: Seasonally adjusted.\nSource: STR; Bureau of Economic Analysis; Tourism Economics")
starta <- as.Date("1995-01-01")
enda <- as.Date("2015-10-01")
index_year <- c(2006)
variable_text <- paste("Index (", index_year, "=100)", sep="")

temp <- ushist_q_m %>% 
  filter(variable == paste(todo[1], "_", todovar, sep="") | 
                           variable == paste(todo2[1], "_", todovar, sep="")) %>%
  spread(variable, value) %>%
     read.zoo(drop=FALSE) %>%
    as.xts %>%
    index_q_xts(index_year=index_year) %>%
    data.frame(date=index(.), .) %>%
    # puts it back into a tidy format with observations based on date and seg
    # and variables in the columns
    melt(id.vars = c("date")) %>%
     separate(variable, c("seg", "var"), sep = "_", extra="merge") %>%
    spread(var, value) %>%
    mutate(seg = as.factor(seg))

temp <- temp %>%
  filter(date > starta, date <= enda)

levels(temp$seg)[levels(temp$seg)==todo[1]] <- todo[2]
levels(temp$seg)[levels(temp$seg)==todo2[1]] <- todo2[2]
colnames(temp) <- c("date", "seg", "value")

p1 <- ggplot() +
 geom_line(data = temp, aes(x = date, y = value, color = seg), size = .7) +
 ggtitle(variable_text) + 
 scale_color_manual(values = setNames(c("grey60", mypallete[10:10]), c(todo[2], todo2[2])))+
 theme(legend.position=c(1, .15)) +
 scale_y_continuous(limits=c(70,115))
p1 <- p1 + geom_rect(data=subset(recession_df_m, start_rec >= min(temp$date)), #trims length
            aes(xmin=start_rec
                ,xmax=end_rec
                ,ymin=-Inf  # to bottom of graph
                ,ymax=Inf), # to top of graph
                 fill="grey40", alpha=0.2)
plot_title_3(plot=p1, grtitle=grtitle, footnote=footnote)
```


## Unemployment
```{r unemployment}
#sets variable and text items
todo <- c("us_up")
grtitle <- c("Unemployment rate, US")
footnote <- c("Source: Bureau of Labor Statistics; Oxford Economics")
starta <- as.Date("2000-01-01")
enda <- as.Date("2017-10-01")
variable_text <- c("Seasonally adjusted")

temp <- ushist_q_m %>% 
  filter(date >= starta, date <= enda, variable == todo) %>%
  spread(variable, value) %>%
  melt(id.vars = c("date")) %>%
  mutate(value = value / 100)

p1 <- ggplot() + 
  geom_line(data = temp[temp$date<=as.Date("2015-04-01"),], 
            aes(x = date, y = value), color=mypallete[10:10]) + 
  geom_line(data = temp[temp$date>=as.Date("2015-04-01"),], 
            aes(x = date, y = value), color=mypallete[10:10],  linetype = "99") +
  ggtitle(variable_text) + 
  scale_y_continuous(labels = percent, limits=c(0,.10)) +
  scale_x_date(labels = date_format("%y"), breaks = "1 year")
# add recession
p1 <- p1+
  geom_rect(data=subset(recession_df_m, start_rec >= min(temp$date)), #trims length
            aes(xmin=start_rec
                ,xmax=end_rec
                ,ymin=-Inf  # to bottom of graph
                ,ymax=Inf), # to top of graph
                 fill="grey40", alpha=0.2)
plot_title_3(plot=p1, grtitle=grtitle, footnote=footnote)
```

## Household net wealth
```{r net_wealth_real}
#sets variable and text items
todo <- c("us_penwallrpc")
grtitle <- c("Household net wealth, real, US")
footnote <- c("Source: Federal Reserve; Oxford Economics")
starta <- as.Date("2000-01-01")
enda <- as.Date("2016-10-01")
variable_text <- c("In trillions of 2014 dollars")
start_max <- as.Date("2000-01-01") # for mean
end_max <- as.Date("2009-10-01")

temp <- usfor_q_m %>% 
  filter(date >= starta, date <= enda, variable == todo) %>%
  spread(variable, value) %>%
  melt(id.vars = c("date")) %>%
    mutate(value = value / 1000) 

# calculates max over selected period and appends it to temp
holdmax <- temp %>% 
  filter(variable == todo, !is.na(value), date >= start_max, date <= end_max) 
holdmax <- max(holdmax$value, na.rm=TRUE)
temp <- temp %>%
    mutate(value_max=holdmax) 

p1 <- ggplot() + 
  geom_line(data = temp[temp$date<=as.Date("2015-04-01"),], 
            aes(x = date, y = value), color=mypallete[10:10], size=.9) + 
    geom_line(data = temp[temp$date>=as.Date("2015-04-01"),], 
            aes(x = date, y = value), color=mypallete[10:10],  size=.9, linetype = "99") +
#   geom_line(data = temp[temp$date>=as.Date("2014-10-01"),], 
#             aes(x = date, y = value), color=mypallete[10:10], size=.5) +
#     geom_point(data = temp[temp$date>=as.Date("2014-10-01"),], 
#             aes(x = date, y = value), color=mypallete[10:10], pch=1, cex=2) +
    geom_line(data = temp[temp$date<=as.Date("2015-04-01"),], 
            aes(x = date, y = value_max), color="grey40") +
 ggtitle(variable_text) + 
  scale_y_continuous(labels = dollar, limits=c(20,100)) +
   scale_x_date(labels = date_format("%y"), breaks = "1 year") +
   annotate("text", x = as.Date("2003-01-01"), y = holdmax+2.5, size=4,
         label = c(paste("Prior peak")))
# add recession
p1 <- p1+
  geom_rect(data=subset(recession_df_m, start_rec >= min(temp$date)), #trims length
            aes(xmin=start_rec
                ,xmax=end_rec
                ,ymin=-Inf  # to bottom of graph
                ,ymax=Inf), # to top of graph
                 fill="grey40", alpha=0.2)
plot_title_3(plot=p1, grtitle=grtitle, footnote=footnote)

temp5 <- subset(recession_df_m, start_rec >= min(temp$date))
```


## Top 25 demand
```{r top25_demand}
grtitle <- c("Top 25 markets, demand")
footnote <- c("Note: Seasonally adjusted. Room demand quarterly through first quarter 2015.\nSource: STR, Tourism Economics")
variable_text <- c("Index (2006=100)")
index_year <- c(2006)

temp <- top25compile %>%
    read.zoo() %>%
  xts() %>%
  index_q_xts(.,index_year=index_year) %>%
  data.frame(date=index(.), .) %>%
  melt(id.vars = c("date"))

temp <- temp %>%
  filter(grepl('demd_sa', variable)) %>%
  filter(variable == "top25us_demd_sa" | 
           variable == "topcoastwonydc_demd_sa" |
           variable == "totus_demd_sa")

temp2 <- ushist_q_m %>%
    filter(variable == "newyork_demd_sa" | variable == "washingtondc_demd_sa" ) %>%
    filter(date > "1987-01-01") %>%
    spread(variable, value) %>%
    na.omit() %>%
    read.zoo(drop=FALSE) %>%
    as.xts %>%
    index_q_xts(index_year=index_year) %>%
    data.frame(date=index(.), .) %>%
    melt(id.vars = c("date"))
  
temp <- rbind(temp, temp2)

temp <- temp %>%
  filter(date > "2005-01-01", date <= "2015-04-01")

levels(temp$variable)[levels(temp$variable)=="top25us_demd_sa"] <- "Top 25 markets"
levels(temp$variable)[levels(temp$variable)=="topcoastwonydc_demd_sa"] <- "Selected coastal markets w/o NY and DC"
levels(temp$variable)[levels(temp$variable)=="newyork_demd_sa"] <- "New York"
levels(temp$variable)[levels(temp$variable)=="washingtondc_demd_sa"] <- "Washington DC"
levels(temp$variable)[levels(temp$variable)=="totus_demd_sa"] <- "Total US"

p1 <- ggplot() +
  geom_line(data = temp, aes(x = date, y = value, color = variable), size = .6) +
  ggtitle(variable_text) +
  theme(legend.position=c(.5, .75)) +
    scale_x_date(breaks = "1 year", labels = date_format("%Y")) +
  scale_color_manual(values = c(mypallete[10:10], mypallete[8:8], "grey40", mypallete[2:2], mypallete[4:4]))
plot_title_3(plot=p1, grtitle=grtitle, footnote=footnote)
```

## Top 25 supply
```{r top25_supply}
grtitle <- c("Top 25 markets, supply")
footnote <- c("Note: Seasonally adjusted. Room supply quarterly through first quarter 2015.\nSource: STR, Tourism Economics")
variable_text <- c("Index (2006=100)")
index_year <- c(2006)

temp <- top25compile %>%
    read.zoo() %>%
  xts() %>%
  index_q_xts(.,index_year=index_year) %>%
  data.frame(date=index(.), .) %>%
  melt(id.vars = c("date"))

temp <- temp %>%
  filter(grepl('supd_sa', variable)) %>%
  filter(variable == "top25us_supd_sa" | 
           variable == "topcoastwonydc_supd_sa" |
           variable == "totus_supd_sa")

temp2 <- ushist_q_m %>%
    filter(variable == "newyork_supd_sa" | variable == "washingtondc_supd_sa" ) %>%
    filter(date > "1987-01-01") %>%
    spread(variable, value) %>%
    na.omit() %>%
    read.zoo(drop=FALSE) %>%
    as.xts %>%
    index_q_xts(index_year=index_year) %>%
    data.frame(date=index(.), .) %>%
    melt(id.vars = c("date"))
  
temp <- rbind(temp, temp2)

temp <- temp %>%
  filter(date > "2005-01-01", date <= "2015-04-01")

levels(temp$variable)[levels(temp$variable)=="top25us_supd_sa"] <- "Top 25 markets"
levels(temp$variable)[levels(temp$variable)=="topcoastwonydc_supd_sa"] <- "Selected coastal markets w/o NY and DC"
levels(temp$variable)[levels(temp$variable)=="newyork_supd_sa"] <- "New York"
levels(temp$variable)[levels(temp$variable)=="washingtondc_supd_sa"] <- "Washington DC"
levels(temp$variable)[levels(temp$variable)=="totus_supd_sa"] <- "Total US"

p1 <- ggplot() +
  geom_line(data = temp, aes(x = date, y = value, color = variable), size = .6) +
  ggtitle(variable_text) +
  theme(legend.position=c(.5, .75)) +
  scale_x_date(breaks = "1 year", labels = date_format("%Y")) +
  scale_color_manual(values = c(mypallete[10:10], mypallete[8:8], "grey40", mypallete[2:2], mypallete[4:4]))
plot_title_3(plot=p1, grtitle=grtitle, footnote=footnote)
```

## San Francisco demand
```{r sanfrancisco_demand}
grtitle <- c("San Francisco hotel room demand")
footnote <- c("Note: Seasonally adjusted. Room demand quarterly through first quarter 2015.\nSource: STR, Tourism Economics")
variable_text <- c("Index (2006=100)")
index_year <- c(2006)
todo <- c("demd_sa")

temp1 <- top25compile_td %>%
  filter(seg == "topcoastwonydc") %>%
  # select_ does standard evaluation
  select_("date", "seg", todo) 

temp2 <- ushist_q_td %>%
  filter(seg == "sanfrancisco") %>%
  filter(date >= "1987-01-01") %>%
  select_("date", "seg", todo)

# nothing in this step needs to change 
temp <- rbind(temp1, temp2) %>%
    # needs to get it back into a format for indexing
    gather(segvar, value, -date, -seg, na.rm = FALSE) %>%
    mutate(segvar = paste(seg, segvar, sep="_")) %>%
    select(-seg) %>%
    spread(segvar, value) %>%
    read.zoo(drop=FALSE) %>%
    as.xts %>%
    index_q_xts(index_year=index_year) %>%
    data.frame(date=index(.), .) %>%
    # puts it back into a tidy format with observations based on date and seg
    # and variables in the columns
    melt(id.vars = c("date")) %>%
     separate(variable, c("seg", "var"), sep = "_", extra="merge") %>%
    spread(var, value) %>%
    mutate(seg = as.factor(seg))

temp <- temp %>%
  filter(date > "1995-01-01", date <= "2015-10-01")

levels(temp$seg)[levels(temp$seg)=="topcoastwonydc"] <- "Selected coastal\nmarkets w/o NY\nand DC"
levels(temp$seg)[levels(temp$seg)=="sanfrancisco"] <- "San Francisco"
colnames(temp) <- c("date", "seg", "value")

p1 <- ggplot() +
  geom_line(data = temp, aes(x = date, y = value, color = seg), size = .8) +
  ggtitle(variable_text) +
  theme(legend.position=c(1, .15)) +
    scale_x_date(breaks = "1 year", labels = date_format("%Y")) +
  scale_color_manual(values = c(mypallete[10:10], "grey60")) +
  scale_y_continuous(limits=c(70,120)) +
geom_rect(data=subset(recession_df_m, start_rec >= min(temp$date)), #trims length
            aes(xmin=start_rec
                ,xmax=end_rec
                ,ymin=-Inf  # to bottom of graph
                ,ymax=Inf), # to top of graph
                fill="grey40", alpha=0.2)
plot_title_3(plot=p1, grtitle=grtitle, footnote=footnote)
```


## San Francisco supply
```{r sanfrancisco_supply}
grtitle <- c("San Francisco hotel room supply")
footnote <- c("Note: Seasonally adjusted data quarterly through first quarter 2015.\nSource: STR, Tourism Economics")
variable_text <- c("Index (2006=100)")
index_year <- c(2006)
todo <- c("supd_sa")

temp1 <- top25compile_td %>%
  filter(seg == "topcoastwonydc") %>%
  # select_ does standard evaluation
  select_("date", "seg", todo) 

temp2 <- ushist_q_td %>%
  filter(seg == "sanfrancisco") %>%
  filter(date >= "1987-01-01") %>%
  select_("date", "seg", todo)

# nothing in this step needs to change 
temp <- rbind(temp1, temp2) %>%
    # needs to get it back into a format for indexing
    gather(segvar, value, -date, -seg, na.rm = FALSE) %>%
    mutate(segvar = paste(seg, segvar, sep="_")) %>%
    select(-seg) %>%
    spread(segvar, value) %>%
    read.zoo(drop=FALSE) %>%
    as.xts %>%
    index_q_xts(index_year=index_year) %>%
    data.frame(date=index(.), .) %>%
    # puts it back into a tidy format with observations based on date and seg
    # and variables in the columns
    melt(id.vars = c("date")) %>%
     separate(variable, c("seg", "var"), sep = "_", extra="merge") %>%
    spread(var, value) %>%
    mutate(seg = as.factor(seg))

temp <- temp %>%
  filter(date > "1995-01-01", date <= "2015-10-01")

levels(temp$seg)[levels(temp$seg)=="topcoastwonydc"] <- "Selected coastal\nmarkets w/o NY\nand DC"
levels(temp$seg)[levels(temp$seg)=="sanfrancisco"] <- "San Francisco"
colnames(temp) <- c("date", "seg", "value")

p1 <- ggplot() +
  geom_line(data = temp, aes(x = date, y = value, color = seg), size = .8) +
  ggtitle(variable_text) +
  theme(legend.position=c(1, .15)) +
    scale_x_date(breaks = "1 year", labels = date_format("%Y")) +
  scale_y_continuous(limits=c(70,120)) +
  scale_color_manual(values = c(mypallete[10:10], "grey60")) +
geom_rect(data=subset(recession_df_m, start_rec >= min(temp$date)), #trims length
            aes(xmin=start_rec
                ,xmax=end_rec
                ,ymin=-Inf  # to bottom of graph
                ,ymax=Inf), # to top of graph
                fill="grey40", alpha=0.2)
plot_title_3(plot=p1, grtitle=grtitle, footnote=footnote)
```


## San Francisco occupancy
```{r sanfrancisco_occ}
grtitle <- c("San Francisco hotel occupancy")
footnote <- c("Note: Seasonally adjusted data quarterly through first quarter 2015.\nSource: STR, Tourism Economics")
variable_text <- c("Occupancy")
index_year <- c(2006)
todo <- c("occ_sa")

temp1 <- top25compile_td %>%
  filter(seg == "topcoastwonydc") %>%
  # select_ does standard evaluation
  select_("date", "seg", todo) 

temp2 <- ushist_q_td %>%
  filter(seg == "sanfrancisco") %>%
  filter(date >= "1987-01-01") %>%
  select_("date", "seg", todo)

# nothing in this step needs to change 
temp <- rbind(temp1, temp2) %>%
    # needs to get it back into a format for indexing
    gather(segvar, value, -date, -seg, na.rm = FALSE) %>%
    mutate(segvar = paste(seg, segvar, sep="_")) %>%
    select(-seg) %>%
    spread(segvar, value) %>%
    read.zoo(drop=FALSE) %>%
    as.xts %>%
    #index_q_xts(index_year=index_year) %>%
    data.frame(date=index(.), .) %>%
    # puts it back into a tidy format with observations based on date and seg
    # and variables in the columns
    melt(id.vars = c("date")) %>%
     separate(variable, c("seg", "var"), sep = "_", extra="merge") %>%
    spread(var, value) %>%
    mutate(seg = as.factor(seg))

temp <- temp %>%
  filter(date > "1995-01-01", date <= "2014-10-01")

levels(temp$seg)[levels(temp$seg)=="topcoastwonydc"] <- "Selected coastal\nmarkets w/o NY\nand DC"
levels(temp$seg)[levels(temp$seg)=="sanfrancisco"] <- "San Francisco"
colnames(temp) <- c("date", "seg", "value")

p1 <- ggplot() +
  geom_line(data = temp, aes(x = date, y = value, color = seg), size = .8) +
  ggtitle(variable_text) +
  theme(legend.position=c(1, .15)) +
    scale_x_date(breaks = "1 year", labels = date_format("%Y")) +
  scale_y_continuous(labels = percent, limits=c(.5,.9)) +
  scale_color_manual(values = c(mypallete[10:10], "grey60")) +
geom_rect(data=subset(recession_df_m, start_rec >= min(temp$date)), #trims length
            aes(xmin=start_rec
                ,xmax=end_rec
                ,ymin=-Inf  # to bottom of graph
                ,ymax=Inf), # to top of graph
                fill="grey40", alpha=0.2)
plot_title_3(plot=p1, grtitle=grtitle, footnote=footnote)

```


## San Francisco and NY occupancy
```{r sanfrancisco_ny_occ}
grtitle <- c("San Francisco and New York hotel occupancy")
footnote <- c("Note: Seasonally adjusted data quarterly through first quarter 2015.\nSource: STR, Tourism Economics")
variable_text <- c("Occupancy")
index_year <- c(2006)
todo <- c("occ_sa")

temp1 <- ushist_q_td %>%
  filter(seg == "sanfrancisco" | seg == "newyork") %>%
  filter(date >= "1987-01-01") %>%
  select_("date", "seg", todo)

# nothing in this step needs to change 
temp <- temp1 %>%
    # needs to get it back into a format for indexing
    gather(segvar, value, -date, -seg, na.rm = FALSE) %>%
    mutate(segvar = paste(seg, segvar, sep="_")) %>%
    select(-seg) %>%
    spread(segvar, value) %>%
    read.zoo(drop=FALSE) %>%
    as.xts %>%
    #index_q_xts(index_year=index_year) %>%
    data.frame(date=index(.), .) %>%
    # puts it back into a tidy format with observations based on date and seg
    # and variables in the columns
    melt(id.vars = c("date")) %>%
     separate(variable, c("seg", "var"), sep = "_", extra="merge") %>%
    spread(var, value) %>%
    mutate(seg = as.factor(seg))

temp <- temp %>%
  filter(date > "1995-01-01", date <= "2015-10-01")

levels(temp$seg)[levels(temp$seg)=="sanfrancisco"] <- "San Francisco"
levels(temp$seg)[levels(temp$seg)=="newyork"] <- "New York"
colnames(temp) <- c("date", "seg", "value")

p1 <- ggplot() +
  geom_line(data = temp, aes(x = date, y = value, color = seg), size = .8) +
  ggtitle(variable_text) +
  theme(legend.position=c(1, .15)) +
    scale_x_date(breaks = "1 year", labels = date_format("%Y")) +
  scale_y_continuous(labels = percent, limits=c(.5,.9)) +
  scale_color_manual(values = c("grey60", mypallete[10:10])) +
geom_rect(data=subset(recession_df_m, start_rec >= min(temp$date)), #trims length
            aes(xmin=start_rec
                ,xmax=end_rec
                ,ymin=-Inf  # to bottom of graph
                ,ymax=Inf), # to top of graph
                fill="grey40", alpha=0.2)
plot_title_3(plot=p1, grtitle=grtitle, footnote=footnote)

```


## San Francisco adr
```{r sanfrancisco_adr}
grtitle <- c("San Francisco real ADR")
footnote <- c("Note: Seasonally adjusted data quarterly through first quarter 2015.\nSource: STR, Tourism Economics")
variable_text <- c("In 2014 dollars")
index_year <- c(2006)
todo <- c("adr_sarpc")

temp1 <- top25compile_td %>%
  filter(seg == "topcoastwonydc") %>%
  # select_ does standard evaluation
  select_("date", "seg", todo) 

temp2 <- ushist_q_td %>%
  filter(seg == "sanfrancisco") %>%
  filter(date >= "1987-01-01") %>%
  select_("date", "seg", todo)

# nothing in this step needs to change 
temp <- rbind(temp1, temp2) %>%
    # needs to get it back into a format for indexing
    gather(segvar, value, -date, -seg, na.rm = FALSE) %>%
    mutate(segvar = paste(seg, segvar, sep="_")) %>%
    select(-seg) %>%
    spread(segvar, value) %>%
    read.zoo(drop=FALSE) %>%
    as.xts %>%
    #index_q_xts(index_year=index_year) %>%
    data.frame(date=index(.), .) %>%
    # puts it back into a tidy format with observations based on date and seg
    # and variables in the columns
    melt(id.vars = c("date")) %>%
     separate(variable, c("seg", "var"), sep = "_", extra="merge") %>%
    spread(var, value) %>%
    mutate(seg = as.factor(seg))

temp <- temp %>%
  filter(date > "1995-01-01", date <= "2015-10-01")

levels(temp$seg)[levels(temp$seg)=="topcoastwonydc"] <- "Selected coastal\nmarkets w/o NY\nand DC"
levels(temp$seg)[levels(temp$seg)=="sanfrancisco"] <- "San Francisco"
colnames(temp) <- c("date", "seg", "value")


p1 <- ggplot() +
  geom_line(data = temp, aes(x = date, y = value, color = seg), size = .8) +
  ggtitle(variable_text) +
  theme(legend.position=c(1, .15)) +
    scale_x_date(breaks = "1 year", labels = date_format("%Y")) +
  scale_y_continuous(labels = dollar, limits=c(75,max(temp$value, na.rm=TRUE) + 5)) +
  scale_color_manual(values = c(mypallete[10:10], "grey60")) +
geom_rect(data=subset(recession_df_m, start_rec >= min(temp$date)), #trims length
            aes(xmin=start_rec
                ,xmax=end_rec
                ,ymin=-Inf  # to bottom of graph
                ,ymax=Inf), # to top of graph
                fill="grey40", alpha=0.2)
plot_title_3(plot=p1, grtitle=grtitle, footnote=footnote)
```

## ADR, real short-term
```{r sanfrancisco_adr_real_st}
todo <- c("sanfrancisco_adr_sarpc")
grtitle <- c("Real ADR, San Francisco")
footnote <- c("Note: Seasonally adjusted.\nSource: STR; Bureau of Economic Analysis; Tourism Economics")
starta <- as.Date("1995-01-01")
enda <- as.Date("2015-04-01")
variable_text <- c("In 2014 dollars")
start_mean <- as.Date("2000-01-01") # for mean
end_mean <- as.Date("2014-10-01")

temp <- ushist_q_m %>% 
  filter(date >= starta, date <= enda, variable == todo) %>%
  spread(variable, value) %>%
  melt(id.vars = c("date")) %>%
  mutate(group_date = cut(date, breaks = as.Date(c("1995-01-01", "2001-01-01", 
                                                   "2004-07-01", "2008-04-01", 
                                                   "2009-07-01","2015-10-01"))))

# calculates mean over selected period
holdmean <- ushist_q_m %>% 
  filter(variable == todo, !is.na(value), date >= start_mean, date <= end_mean) 
holdmean <- mean(holdmean$value, na.rm=TRUE)

# prior high
holdhigh <- ushist_q_m %>% 
  filter(variable == todo, !is.na(value), date >= starta, date <= "2010-01-01") 
holdhigh <- max(holdhigh$value, na.rm=TRUE)

# most recent observation
holdcurrent <- subset(temp, date == enda)
holdcurrent_ob <- as.integer(holdcurrent[1,"value"])
holdcurrent_date <- paste(year(as.Date(holdcurrent[1,"date"])), "Q",
                          quarter(as.Date(holdcurrent[1,"date"]), with_year=FALSE),
                          sep="")

p1 <- ggplot(data = temp, aes(x = date, y = value, shape = factor(group_date))) + 
  geom_line(aes(x= date, y=value, group=1), size = .7, color=mypallete[10:10]) +
  ggtitle(variable_text) + 
  scale_y_continuous(labels = dollar, limits=c(100,max(temp$value, na.rm=TRUE) + 5)) +
  geom_point(data=holdcurrent, colour=mypallete[10:10], shape=16, size=3) +  # this adds a red point
  geom_text(data=holdcurrent, label=paste(holdcurrent_date, " $", 
                                          holdcurrent_ob, sep=""), 
            vjust=0, hjust=1.2, size=3) # this adds a label for the red point
# add mean 
p2 <- p1 +
  geom_hline(aes(yintercept=holdmean), color="grey60", size=.5, alpha=.6) +
  annotate("text", x = as.Date("2004-07-01"), y = holdmean+6, size=3,
           label = c(paste("Long-term average: $",sprintf("%0.f", holdmean), "\n(2000 to 2014)",sep="")))
# add high
p2 <- p2 +
  geom_hline(aes(yintercept=holdhigh), color="grey60", size=.5, alpha=.6) +
  annotate("text", x = as.Date("2000-10-01"), y = holdhigh+6, size=3,
           label = c(paste("Previous peak: $",sprintf("%0.f", holdhigh), "\n(2000 Q4)",sep="")))
plot_title_3(plot=p2, grtitle=grtitle, footnote=footnote)

# add lines
p3 <- p1 + 
  geom_line(stat="smooth",  method="lm", 
              color="grey60", size=.6, alpha=.8, span=1, se = FALSE) 
plot_title_3(plot=p3, grtitle=grtitle, footnote=footnote)

```


## ADR, real short-term
```{r upu_adr_real_st}
todo <- c("upuus_adr_sarpc")
grtitle <- c("Real ADR, US Upper upscale")
footnote <- c("Note: Seasonally adjusted.\nSource: STR; Bureau of Economic Analysis; Tourism Economics")
starta <- as.Date("1995-01-01")
enda <- as.Date("2015-04-01")
variable_text <- c("In 2014 dollars")
start_mean <- as.Date("2000-01-01") # for mean
end_mean <- as.Date("2014-10-01")

temp <- ushist_q_m %>% 
  filter(date >= starta, date <= enda, variable == todo) %>%
  spread(variable, value) %>%
  melt(id.vars = c("date")) %>%
  mutate(group_date = cut(date, breaks = as.Date(c("1995-01-01", "2001-01-01", 
                                                   "2004-07-01", "2008-04-01", 
                                                   "2009-07-01","2015-10-01"))))

# calculates mean over selected period
holdmean <- ushist_q_m %>% 
  filter(variable == todo, !is.na(value), date >= start_mean, date <= end_mean) 
holdmean <- mean(holdmean$value, na.rm=TRUE)

# prior high
holdhigh <- ushist_q_m %>% 
  filter(variable == todo, !is.na(value), date >= "2004-01-01", date <= "2010-01-01") 
holdhigh <- max(holdhigh$value, na.rm=TRUE)

# most recent observation
holdcurrent <- subset(temp, date == enda)
holdcurrent_ob <- as.integer(holdcurrent[1,"value"])
holdcurrent_date <- paste(year(as.Date(holdcurrent[1,"date"])), "Q",
                          quarter(as.Date(holdcurrent[1,"date"]), with_year=FALSE),
                          sep="")

p1 <- ggplot(data = temp, aes(x = date, y = value, shape = factor(group_date))) + 
  geom_line(aes(x= date, y=value, group=1), size = .7, color=mypallete[10:10]) +
  ggtitle(variable_text) + 
  scale_y_continuous(labels = dollar, limits=c(120,max(temp$value, na.rm=TRUE) + 5)) +
  geom_point(data=holdcurrent, colour=mypallete[10:10], shape=16, size=3) +  # this adds a red point
  geom_text(data=holdcurrent, label=paste(holdcurrent_date, " $", 
                                          holdcurrent_ob, sep=""), 
            vjust=0, hjust=1.2, size=3) # this adds a label for the red point
# add mean 
p2 <- p1 +
  geom_hline(aes(yintercept=holdmean), color="grey60", size=.5, alpha=.6) +
  annotate("text", x = as.Date("2004-01-01"), y = holdmean+4, size=3,
           label = c(paste("Long-term average: $",sprintf("%0.f", holdmean), "\n(2000 to 2014)",sep="")))
# add high
p2 <- p2 +
  geom_hline(aes(yintercept=holdhigh), color="grey60", size=.5, alpha=.6) +
  annotate("text", x = as.Date("2007-10-01"), y = holdhigh+6, size=3,
           label = c(paste("Previous peak: $",sprintf("%0.f", holdhigh), "\n(2007 Q4)",sep="")))
plot_title_3(plot=p2, grtitle=grtitle, footnote=footnote)

# add lines
p3 <- p1 + 
  geom_line(stat="smooth",  method="lm", 
              color="grey60", size=.6, alpha=.8, span=1, se = FALSE) 
plot_title_3(plot=p3, grtitle=grtitle, footnote=footnote)

```
