---
title: "US overview  slides"
author: "Tourism Economics"
date: "Sunday, October 12, 2014"
output:
  ioslides_presentation:
    fig_height: 5
    fig_width: 8.5
    smaller: yes
  beamer_presentation: default
  slidy_presentation: default
---

## Slide with Bullets

- Bullet 1
- Bullet 2
- Bullet 3

## Slide with R Code and Output
```{r load_files, echo=FALSE, message=FALSE, warning=FALSE}
require(zoo)
require(xts)
require(dplyr)
require(reshape2)
require(ggplot2)
require(RColorBrewer)
require(gridExtra)
require(gtable)
require(tidyr)
require(knitr)

fpath <- c("~/Project/R projects/lodfor/")

load(paste(fpath, "output_data/ushist_q.Rdata", sep=""))
load(paste(fpath, "output_data/ushist_ind_q.Rdata", sep=""))
load(paste(fpath, "output_data/ushist_m.Rdata", sep=""))
```

```{r readchunk, echo=FALSE, message=FALSE, warning=FALSE}
read_chunk('~/Project/R projects/lodfor/scripts/functions.R')

source('~/Project/R projects/lodfor/scripts/functions.R')
```

```{r first, echo=FALSE, message=FALSE, warning=FALSE}
<<variablesXY>>
```

```{r create_dataframes, echo=FALSE, message=FALSE, warning=FALSE}
# puts the monthly str data into a melted data frame
xts1 <- ushist_m
xts1 <- window(xts1, end = as.Date("2014-09-01"))
df1 <- data.frame(time=time(xts1), xts1)
ushist_m <- df1
ushist_m_m <- melt(ushist_m, id.vars = c("time"))
#ushist_m_m[1:4,]

# puts the quarterly ushist into a melted data frame
xts1 <- ushist_q
xts1 <- window(xts1, end = as.Date("2017-10-01"))
df1 <- data.frame(time=time(xts1), xts1)
ushist_q_df <- df1
ushist_q_m <- melt(ushist_q_df, id.vars = c("time"))
#ushist_q_m[1:4,]

# puts the quarterly ushist indexed into a melted data frame
xts1 <- ushist_ind_q
xts1 <- window(xts1, end = as.Date("2014-09-01"))
df1 <- data.frame(time=time(xts1), xts1)
ushist_ind_q_df <- df1
ushist_ind_q_m <- melt(ushist_ind_q_df, id.vars = c("time"))
#ushist_ind_q_m[1:4,]

# this is if I wanted to do things with a tidy format
# takes the summed data and spreads it into a tidy format with
# tidyr and then calculates the occupancy and revpar series
tidy_ushist_q <- data.frame(time=time(ushist_q), ushist_q)%>%
  select(-year,-month,-qtr,-days) %>%
  gather(segvar, value, -time, na.rm = FALSE) %>%
  # I had difficulty separating by the underscore
  # because there are more than one underscore in some
  # so my solution was to mutate the column, applying 
  # the sub function, which replaces the first occurance of
  # the underscore with a period
  mutate(segvar = sub("_",".", segvar)) %>%
  # then run the separate on the period, using backslashes
  # to escape out of the second character
  separate(segvar, c("seg", "variable"), sep = "\\.") 
```

## Slide with R Code and Output
Loads code_book_matrix and shows example contents
```{r load_code_book_matrix, echo=FALSE, message=FALSE, warning=FALSE}
fname <- c(paste(fpath, "input_data/code_book_matrix.csv", sep=""))
code_book_matrix <- read.csv(fname, stringsAsFactors=FALSE)
#head(code_book_matrix)
rm(fname)
```
Displays palette and sets the ts1 theme
```{r set_theme, echo=FALSE, message=FALSE, warning=FALSE}
#display.brewer.pal(10, "RdBu")
mypallete <- brewer.pal( 10 , "RdBu" )
colors_ts1 <- scale_colour_manual(values = mypallete[c(10, 1, 5, 4)])
# I don't use the following, was an example I saw somewhere maybe as a way to 
# interpolate additional palette colors
#mypal <- colorRampPalette( brewer.pal( 10 , "RdBu" ) )
theme_ts1 <- function (base_size = 12, base_family = "") {
  theme_classic(base_size = base_size, base_family = base_family) %+replace%
    theme(                                 
      panel.grid.major.x=element_blank(),
      panel.grid.minor.x=element_blank(),
      panel.grid.minor.y=element_blank(),
      axis.ticks.y=element_line(size=.2),
      axis.ticks.x=element_line(size=.2),
      panel.background=element_blank(),
      legend.title=element_blank(),
      legend.key=element_rect(fill="white", colour = "white"),
      legend.key.size=unit(1.5, "cm"),
      legend.text=element_text(size=rel(1.1)),
      legend.position = c(1, .1),
      legend.position = "none",
      legend.justification = "right",
      axis.line=element_line(size=.2),
      axis.title.y=element_blank(),
      axis.title.x=element_blank(),
      axis.text=element_text(color="black",size=rel(.9)),
      plot.title=element_text(size=base_size * .8, face="plain",hjust=0,vjust=1)
  #       theme(plot.title = element_text(lineheight=.8, face="bold"))
    )
}
theme_set(theme_ts1())
#this is also a useful theme to keep in mind
#theme_classic()
# this function gets the settings used by the current theme
#theme_get()
```

## Demand, monthly + GDP 
```{r demand_monthly_gdp, echo=FALSE, message=FALSE, warning=FALSE, dev='CairoPNG'}
#sets variable and text items
todo <- c("totus_demd_sa")
grtitle <- c("Room demand")
footnote <- c("Source: Smith Travel Research, Tourism Economics")
starta <- as.Date("2004-01-01")
enda <- as.Date("2015-10-01")
index_year <- as.numeric(2006)
variable_text <- c(paste("Index ",index_year,"=100",sep=""))
variable_legend_1 <- c("Room demand")
variable_legend_2 <- c("GDP")
# filters
temp <- filter(ushist_m_m, variable == todo, time >= starta, time <= enda) 
temp2 <- filter(ushist_q_m, variable == "us_gdp", time >= starta, time <= enda) 

# takes filtered dataframe converts to xts to calculate index, 
# then back to dataframe
# seems like a lot of work, but my index function requires xts
temp <- temp %>% 
  spread(variable, value) %>% 
  read.zoo(drop=FALSE) %>% 
  xts() %>%
  index_m(index_year=index_year) %>%
  data.frame() 
temp <- melt(as.matrix(temp))
temp <- rename(temp, time=Var1, variable=Var2)
temp$time <- as.Date(temp$time)

# takes filtered dataframe converts to xts to calculate index, 
# then back to dataframe
# seems like a lot of work, but my index function requires xts
temp2 <- temp2 %>% 
  spread(variable, value) %>% 
  read.zoo(drop=FALSE) %>% 
  xts() %>%
  index_m(index_year=index_year) %>%
  data.frame() 
temp2 <- melt(as.matrix(temp2))
temp2 <- rename(temp2, time=Var1, variable=Var2)
temp2$time <- as.Date(temp2$time)

p1 <- ggplot() +
  geom_line(data = temp, aes(x = time, y = value, color = variable), size = .6) + 
  geom_line(data = temp2, aes(x = time, y = value, color = variable), size = .9) +
  ggtitle(variable_text) +
  theme(legend.position=c(1, .2)) +
  scale_color_manual(values = c(mypallete[7:7], "grey40"), labels=c(variable_legend_1,variable_legend_2)) + 
  stat_smooth(data = temp, aes(x = time, y = value), method="loess", 
              color=mypallete[9:9], alpha=.4, span=.2, se = FALSE, fullrange=FALSE, size=.9, show_guide=FALSE)
plot_title_1(plot=p1, grtitle=grtitle, footnote=footnote)
```

## Demand, ratio to population 
```{r demand_ratio_pop, echo=FALSE, message=FALSE, warning=FALSE, dev='CairoPNG'}
#sets variable and text items
#todo <- c("totus_demd_sa")
grtitle <- c("Room demand per capita")
footnote <- c("Source: Smith Travel Research; Census Bureau; Tourism Economics")
starta <- as.Date("1987-01-01")
enda <- as.Date("2014-10-01")
variable_text <- c("Annual room nights per capita \n(working age population)")
variable_legend_1 <- c("Room demand")

temp <- ushist_q_m %>% 
  filter(variable == "totus_demd_sa" | variable == "us_popw", time >= starta, time <= enda) %>%
  spread(variable, value) %>%
  mutate(dem_popw = totus_demd_sa * 365 / us_popw*1000) %>%
  select(time, dem_popw) %>%
  melt(id.vars = c("time"))

p1 <- ggplot() +
  geom_line(data = temp, aes(x = time, y = value, color = variable), size = .7) +
 ggtitle(variable_text) + 
scale_color_manual(values = c(mypallete[10:10], "grey70")) +
  stat_smooth(data = temp, aes(x = time, y = value), method=lm, fill = "grey90", color="grey40", alpha=.4, span=.7)
plot_title_1(plot=p1, grtitle=grtitle, footnote=footnote)
```

## Demand, ratio to employment 
```{r demand_ratio_emp, echo=FALSE, message=FALSE, warning=FALSE, dev='CairoPNG'}
#sets variable and text items
#todo <- c("totus_demd_sa")
grtitle <- c("Room demand as ratio to total employment")
footnote <- c("Source: Smith Travel Research; Bureau of Labor Statistics; Tourism Economics")
starta <- as.Date("1987-01-01")
enda <- as.Date("2014-10-01")
variable_text <- c("Annual room nights per employed person \n(household survey employment)")
variable_legend_1 <- c("Room demand")

temp <- ushist_q_m %>% 
  filter(variable == "totus_demd_sa" | variable == "us_et", time >= starta, time <= enda) %>%
  spread(variable, value) %>%
  mutate(dem_et = totus_demd_sa * 365 / us_et*1000) %>%
  select(time, dem_et) %>%
  melt(id.vars = c("time"))

p1 <- ggplot() +
  geom_line(data = temp, aes(x = time, y = value, color = variable), size = .7) +
 ggtitle(variable_text) + 
scale_color_manual(values = c(mypallete[10:10], "grey70")) +
  stat_smooth(data = temp, aes(x = time, y = value), method=lm, fill = "grey90", color="grey40", alpha=.4, span=.7)
plot_title_1(plot=p1, grtitle=grtitle, footnote=footnote)
```

## RevPAR, real long-term
```{r revpar_real_lt, echo=FALSE, message=FALSE, warning=FALSE, dev='CairoPNG'}
#sets variable and text items
todo <- c("totus_revpar_sarpc")
grtitle <- c("Real RevPAR, US")
footnote <- c("Source: Smith Travel Research; Bureau of Economic Analysis; Tourism Economics")
starta <- as.Date("1987-01-01")
enda <- as.Date("2014-10-01")
variable_text <- c("Seasonally adjusted")

temp <- ushist_q_m %>% 
  filter(time >= starta, time <= enda, variable == todo) %>%
  spread(variable, value) %>%
  melt(id.vars = c("time"))

# calculating mean from a certain date forward
holdmean <- temp %>%
  filter(time >= as.Date("2000-01-01"), time <= as.Date("2013-10-01") )
holdmean <- mean(holdmean$value, na.rm=TRUE)

p1 <- ggplot() +
 geom_line(data = temp, aes(x = time, y = value, color = variable), size = .7) +
 ggtitle(variable_text) + 
 scale_color_manual(values = c(mypallete[10:10], "grey70")) +
 geom_hline(yintercept = holdmean, colour = "grey50", size = 0.5) +
 annotate("text", x = as.Date("1990-01-01"), y = holdmean+1, size=3,
         label = c(paste("Long-term average: $",sprintf("%.2f", holdmean), "\n(2000 to 2013)",sep="")))+ 
  scale_y_continuous(labels = dollar)
plot_title_1(plot=p1, grtitle=grtitle, footnote=footnote)
```

## RevPAR, real medium-term
```{r revpar_real_mt, echo=FALSE, message=FALSE, warning=FALSE, dev='CairoPNG'}
#sets variable and text items
todo <- c("totus_revpar_sarpc")
grtitle <- c("Real RevPAR, US")
footnote <- c("Source: Smith Travel Research; Bureau of Economic Analysis; Tourism Economics")
starta <- as.Date("2001-01-01")
enda <- as.Date("2014-10-01")
variable_text <- c("Seasonally adjusted")

temp <- ushist_q_m %>% 
  filter(time >= starta, time <= enda, variable == todo) %>%
  spread(variable, value) %>%
  melt(id.vars = c("time"))

p1 <- ggplot() +
  geom_line(data = temp, aes(x = time, y = value, color = variable), size = .7) +
 ggtitle(variable_text) + 
scale_color_manual(values = c(mypallete[10:10], "grey70"))  + 
  scale_y_continuous(labels = dollar)
plot_title_1(plot=p1, grtitle=grtitle, footnote=footnote)
```


## RevPAR, real short-term
```{r revpar_real_st, echo=FALSE, message=FALSE, warning=FALSE, dev='CairoPNG'}
#sets variable and text items
todo <- c("totus_revpar_sarpc")
grtitle <- c("Real RevPAR, US")
footnote <- c("Source: Smith Travel Research; Bureau of Economic Analysis; Tourism Economics")
starta <- as.Date("2006-01-01")
enda <- as.Date("2014-10-01")
variable_text <- c("Seasonally adjusted")

temp <- ushist_q_m %>% 
  filter(time >= starta, time <= enda, variable == todo) %>%
  spread(variable, value) %>%
  melt(id.vars = c("time"))%>%
  mutate(group_date = cut(time, breaks = as.Date(c("2004-01-01", "2008-01-01", "2009-10-01","2014-10-01"))))

p1 <- ggplot(data = temp, aes(x = time, y = value, shape = factor(group_date))) + 
 geom_line(aes(x= time, y=value, group=1), size = .7, color=mypallete[10:10]) +
 ggtitle(variable_text) + 
 scale_color_manual(values = c(mypallete[10:10], "grey70"))  + 
 stat_smooth(method="lm", fill = "grey70", 
             color="grey40", alpha=.4, span=.8, se = FALSE)+ 
  scale_y_continuous(labels = dollar)
plot_title_1(plot=p1, grtitle=grtitle, footnote=footnote)
```

## ADR, growth, short-term
```{r adr_gr_st, echo=FALSE, message=FALSE, warning=FALSE, dev='CairoPNG'}
#sets variable and text items
todo <- c("totus_adr_sa")
grtitle <- c("ADR, US")
footnote <- c("Source: Smith Travel Research; Tourism Economics")
starta <- as.Date("2008-01-01")
enda <- as.Date("2014-10-01")
variable_text <- c("Seasonally adjusted")

temp <- ushist_q_m %>% 
  filter(variable == todo) %>%
  spread(variable, value) %>%
  melt(id.vars = c("time"))%>%
  mutate(group_date = cut(time, breaks = as.Date(c("2004-01-01", "2008-01-01", "2009-10-01","2014-10-01")))) %>%
  mutate(cagr = (value / lag(value))^4 -1, pchya = (value/lag(value, 4)) -1) %>%
  filter(time >= starta, time <= enda) %>%
  melt(id.vars = c("time")) %>%
  filter(variable == "cagr" | variable == "pchya")
temp$value <- as.numeric(temp$value)
temp$time <- as.Date(temp$time)

p1 <- ggplot(data = temp, aes(x = time, y = value, group=variable)) + 
 geom_line(size = .7, color=mypallete[10:10]) +
  geom_point() +
 ggtitle(variable_text) + 
 scale_color_manual(values = c(mypallete[10:10], "grey70"))  + 
 stat_smooth(method="loess", fill = "grey70", 
             color="grey40", alpha=.4, span=.8, se = TRUE) +
 scale_y_continuous(labels = percent)  +
 facet_wrap(~ variable, ncol=1, scales = "free")+
# doesn't add minor tick marks, just for grid I guess 
 scale_x_date(labels = date_format("%Y"), breaks = "1 year", minor_breaks = "3 months") 

# useful
#http://stackoverflow.com/questions/10151123/how-to-specify-columns-in-facet-grid-or-how-to-change-labels-in-facet-wrap
plot_title_1(plot=p1, grtitle=grtitle, footnote=footnote)
```

## Occupancy, real medium-term
```{r occupancy_mt, echo=FALSE, message=FALSE, warning=FALSE, dev='CairoPNG'}
#sets variable and text items
todo <- c("totus_occ_sa")
grtitle <- c("Occupancy")
footnote <- c("Source: Smith Travel Research; Tourism Economics")
starta <- as.Date("2001-01-01")
enda <- as.Date("2014-10-01")
variable_text <- c("Seasonally adjusted")

temp <- ushist_q_m %>% 
  filter(time >= starta, time <= enda, variable == todo) %>%
  spread(variable, value) %>%
  melt(id.vars = c("time"))

p1 <- ggplot() +
  geom_line(data = temp, aes(x = time, y = value, color = variable), size = .7) +
 ggtitle(variable_text) + 
scale_color_manual(values = c(mypallete[10:10], "grey70")) + 
  scale_y_continuous(labels = percent) 
plot_title_1(plot=p1, grtitle=grtitle, footnote=footnote)
```

## ADR, real long-term
```{r adr_real_lt, echo=FALSE, message=FALSE, warning=FALSE, dev='CairoPNG'}
todo <- c("totus_adr_sarpc")
grtitle <- c("Real ADR, US")
footnote <- c("Source: Smith Travel Research; Bureau of Economic Analysis; Tourism Economics")
starta <- as.Date("1987-01-01")
enda <- as.Date("2014-10-01")
variable_text <- c("Seasonally adjusted")

temp <- ushist_q_m %>% 
  filter(time >= starta, time <= enda, variable == todo) %>%
  spread(variable, value) %>%
  melt(id.vars = c("time"))%>%
  mutate(group_date = cut(time, breaks = as.Date(c("1987-01-01", "1998-01-01","2014-10-01"))))

p1 <- ggplot(data = temp, aes(x = time, y = value, color = variable, shape = factor(group_date))) +
  geom_line(aes(x= time, y=value, group=1), size = .7) +
  ggtitle(variable_text) + 
  scale_color_manual(values = c(mypallete[10:10], "grey70")) +
  stat_smooth(method="lm", fill = "grey90", 
              color="grey40", span=.7, se = FALSE)+ 
  scale_y_continuous(labels = dollar)
plot_title_1(plot=p1, grtitle=grtitle, footnote=footnote)
```

## ADR, real medium-term
```{r adr_real_mt, echo=FALSE, message=FALSE, warning=FALSE, dev='CairoPNG'}
todo <- c("totus_adr_sarpc")
grtitle <- c("Real ADR, US")
footnote <- c("Source: Smith Travel Research; Bureau of Economic Analysis; Tourism Economics")
starta <- as.Date("2001-01-01")
enda <- as.Date("2014-10-01")
variable_text <- c("Seasonally adjusted")

temp <- ushist_q_m %>% 
  filter(time >= starta, time <= enda, variable == todo) %>%
  spread(variable, value) %>%
  melt(id.vars = c("time"))

p1 <- ggplot() +
  geom_line(data = temp, aes(x = time, y = value, color = variable), size = .7) +
 ggtitle(variable_text) + 
scale_color_manual(values = c(mypallete[10:10], "grey70")) + 
  scale_y_continuous(labels = dollar)
plot_title_1(plot=p1, grtitle=grtitle, footnote=footnote)
```

## ADR, real short-term
```{r adr_real_st, echo=FALSE, message=FALSE, warning=FALSE, dev='CairoPNG'}
todo <- c("totus_adr_sarpc")
grtitle <- c("Real ADR, US")
footnote <- c("Source: Smith Travel Research; Bureau of Economic Analysis; Tourism Economics")
starta <- as.Date("2006-01-01")
enda <- as.Date("2014-10-01")
variable_text <- c("Seasonally adjusted")

temp <- ushist_q_m %>% 
  filter(time >= starta, time <= enda, variable == todo) %>%
  spread(variable, value) %>%
  melt(id.vars = c("time")) %>%
  mutate(group_date = cut(time, breaks = as.Date(c("2004-01-01", "2008-04-01", "2010-01-01","2014-10-01"))))

p1 <- ggplot(data = temp, aes(x = time, y = value, shape = factor(group_date))) + 
 geom_line(aes(x= time, y=value, group=1), size = .7, color=mypallete[10:10]) +
 ggtitle(variable_text) + 
 scale_color_manual(values = c(mypallete[10:10], "grey70"))  + 
 stat_smooth(method="lm", fill = "grey70", 
             color="grey40", alpha=.4, span=.8, se = FALSE)+ 
  scale_y_continuous(labels = dollar)
plot_title_1(plot=p1, grtitle=grtitle, footnote=footnote)
```

## ADR, short-term
```{r adr_st, echo=FALSE, message=FALSE, warning=FALSE, dev='CairoPNG'}
todo <- c("totus_adr_sa")
grtitle <- c("ADR, US")
footnote <- c("Source: Smith Travel Research; Bureau of Economic Analysis; Tourism Economics")
starta <- as.Date("2006-01-01")
enda <- as.Date("2014-10-01")
variable_text <- c("Seasonally adjusted")

temp <- ushist_q_m %>% 
  filter(time >= starta, time <= enda, variable == todo) %>%
  spread(variable, value) %>%
  melt(id.vars = c("time")) %>%
  mutate(group_date = cut(time, breaks = as.Date(c("2004-01-01", "2008-04-01", "2010-01-01","2014-10-01"))))

p1 <- ggplot(data = temp, aes(x = time, y = value, shape = factor(group_date))) + 
 geom_line(aes(x= time, y=value, group=1), size = .7, color=mypallete[10:10]) +
 ggtitle(variable_text) + 
 scale_color_manual(values = c(mypallete[10:10], "grey70"))  + 
 stat_smooth(method="lm", fill = "grey70", 
             color="grey40", alpha=.4, span=.8, se = FALSE)+ 
  scale_y_continuous(labels = dollar)
plot_title_1(plot=p1, grtitle=grtitle, footnote=footnote)
```

## Corporate profits
```{r corp_profits, echo=FALSE, message=FALSE, warning=FALSE, dev='CairoPNG'}
todo <- c("us_cogtp")
grtitle <- c("Corporate profits")
footnote <- c("Source: Bureau of Economic Analysis; Tourism Economics")
starta <- as.Date("2004-01-01")
enda <- as.Date("2016-10-01")
variable_text <- c("Billions, seasonally adjusted")

temp <- ushist_q_m %>% 
  filter(time >= starta, time <= enda, variable == todo) %>%
  spread(variable, value) %>%
  melt(id.vars = c("time")) %>%
  mutate(group_date = cut(time, breaks = as.Date(c(starta, enda))))

p1 <- ggplot(data = temp, aes(x = time, y = value, shape = factor(group_date))) + 
 geom_line(aes(x= time, y=value, group=1), size = .7, color=mypallete[10:10]) +
 ggtitle(variable_text) + 
 scale_color_manual(values = c(mypallete[10:10], "grey70"))  + 
 stat_smooth(method="lm", fill = "grey70", 
             color="grey40", alpha=.4, span=.8, se = FALSE)+ 
  scale_y_continuous(labels = dollar)
plot_title_1(plot=p1, grtitle=grtitle, footnote=footnote)
```

## Net wealth
```{r net_wealth, echo=FALSE, message=FALSE, warning=FALSE, dev='CairoPNG'}
#sets variable and text items
todo <- c("us_penw")
grtitle <- c("Net wealth")
footnote <- c("Source: Federal Reserve; Tourism Economics")
starta <- as.Date("2004-01-01")
enda <- as.Date("2016-10-01")
variable_text <- c("Household sector, end of quarter, \ntrillions, seasonally adjusted")
#variable_legend_1 <- c("Room demand")

temp <- ushist_q_m %>% 
  filter(time >= starta, time <= enda, variable == todo) %>%
  spread(variable, value) %>%
  melt(id.vars = c("time")) %>%
  mutate(group_date = cut(time, breaks = as.Date(c(starta, enda)))) %>%
  mutate(value = value /1000) # to put into trillions

p1 <- ggplot(data = temp, aes(x = time, y = value, shape = factor(group_date))) + 
 geom_line(aes(x= time, y=value, group=1), size = .7, color=mypallete[10:10]) +
 ggtitle(variable_text) + 
 scale_color_manual(values = c(mypallete[10:10], "grey70"))  + 
 stat_smooth(method="lm", fill = "grey70", 
             color="grey40", alpha=.4, span=.8, se = FALSE)+ 
  scale_y_continuous(labels = dollar)
plot_title_1(plot=p1, grtitle=grtitle, footnote=footnote)
```

## Unemployment
```{r unemployment, echo=FALSE, message=FALSE, warning=FALSE, dev='CairoPNG'}
#sets variable and text items
todo <- c("us_up")
grtitle <- c("Unemployment rate")
footnote <- c("Source: Bureau of Labor Statistics; Tourism Economics")
starta <- as.Date("2000-01-01")
enda <- as.Date("2017-10-01")
variable_text <- c("Seasonally adjusted")
#variable_legend_1 <- c("Room demand")

temp <- ushist_q_m %>% 
  filter(time >= starta, time <= enda, variable == todo) %>%
  spread(variable, value) %>%
  melt(id.vars = c("time")) %>%
  mutate(value = value / 100)

p1 <- ggplot(data = temp, aes(x = time, y = value)) + 
 geom_line(aes(x= time, y=value), size = .7, color=mypallete[10:10]) +
 ggtitle(variable_text) + 
 scale_color_manual(values = c(mypallete[10:10], "grey70")) +
  scale_y_continuous(labels = percent)
plot_title_1(plot=p1, grtitle=grtitle, footnote=footnote)
```

## CPI
```{r cpi, echo=FALSE, message=FALSE, warning=FALSE, dev='CairoPNG'}
#sets variable and text items
todo <- c("us_cpi")
grtitle <- c("Consumer price index")
footnote <- c("Source: Bureau of Labor Statistics; Oxford Economics")
starta <- as.Date("2003-01-01")
enda <- as.Date("2015-10-01")
variable_text <- c("Percentage change from prior year")

temp <- ushist_q_m %>% 
  filter(variable == todo) %>%
  spread(variable, value) %>%
  melt(id.vars = c("time")) %>%
  # I verified the following growth calculation works
  mutate(cagr = (value / lag(value))^4 -1, pchya = (value/lag(value, 4)) -1) %>% 
  filter(time >= starta, time <= enda)

p1 <- ggplot(data = temp, aes(x = time, y = pchya)) + 
 geom_line(aes(x= time, y=pchya), size = .7, color=mypallete[10:10]) +
 ggtitle(variable_text) + 
 scale_color_manual(values = c(mypallete[10:10], "grey70")) +
  scale_y_continuous(labels = percent) +
  stat_smooth()
plot_title_1(plot=p1, grtitle=grtitle, footnote=footnote)
```
## Chain scales

## Occupancy, chains upper medium-term
```{r occ_chains_upper_mt, echo=FALSE, message=FALSE, warning=FALSE, dev='CairoPNG'}
todo1 <- c("totus_occ_sa")
todo2 <- c("luxus_occ_sa")
todo3 <- c("upuus_occ_sa")
todo4 <- c("upsus_occ_sa")
grtitle <- c("Occupancy, higher-priced chain scales")
footnote <- c("Source: Smith Travel Research; Tourism Economics")
starta <- as.Date("1999-01-01")
enda <- as.Date("2014-10-01")
variable_text <- c("Seasonally adjusted, \nIndex 2005=100")
variable_legend_1 <- c("US")
variable_legend_2 <- c("Luxury")
variable_legend_3 <- c("Upper upscale")
variable_legend_4 <- c("Upscale")

temp <- ushist_ind_q_m %>% 
  filter(time >= starta, time <= enda, 
         variable == todo1 | variable == todo2 | variable == todo3 | 
           variable == todo4) %>%
  spread(variable, value) %>%
  melt(id.vars = c("time"))

holdnames <-setNames(c("grey70", mypallete[10:10], mypallete[8:8], mypallete[7:7]), 
                     c(todo1, todo2, todo3, todo4))
legendnames <- setNames(c(variable_legend_1, variable_legend_2, 
                          variable_legend_3, variable_legend_4),
                        c(todo1, todo2, todo3, todo4))

p1 <- ggplot(data = temp, aes(x = time, y = value, color = variable)) +
 geom_line() +
 ggtitle(variable_text) +
 theme(legend.position=c(1, .2)) +
 scale_colour_manual(values=holdnames, labels=legendnames) +
theme(legend.text = element_text(size=10)) + 
  theme(legend.key.size = unit(.8, "cm"))
plot_title_1(plot=p1, grtitle=grtitle, footnote=footnote)
```

## Occupancy, chains lower medium-term
```{r occ_chains_lower_mt, echo=FALSE, message=FALSE, warning=FALSE, dev='CairoPNG'}
todo1 <- c("totus_occ_sa")
todo2 <- c("upmus_occ_sa")
todo3 <- c("midus_occ_sa")
todo4 <- c("ecous_occ_sa")
grtitle <- c("Occupancy, lower-priced chain scales")
footnote <- c("Source: Smith Travel Research; Tourism Economics")
starta <- as.Date("1999-01-01")
enda <- as.Date("2014-10-01")
variable_text <- c("Seasonally adjusted, \nIndex 2005=100")
variable_legend_1 <- c("US")
variable_legend_2 <- c("Upper midscale")
variable_legend_3 <- c("Midscale")
variable_legend_4 <- c("Economy")

temp <- ushist_ind_q_m %>% 
  filter(time >= starta, time <= enda, 
         variable == todo1 | variable == todo2 | variable == todo3 | 
           variable == todo4) %>%
  spread(variable, value) %>%
  melt(id.vars = c("time"))

holdnames <-setNames(c("grey70", mypallete[10:10], mypallete[8:8], mypallete[7:7]), 
                     c(todo1, todo2, todo3, todo4))
legendnames <- setNames(c(variable_legend_1, variable_legend_2, 
                          variable_legend_3, variable_legend_4),
                        c(todo1, todo2, todo3, todo4))

p1 <- ggplot(data = temp, aes(x = time, y = value, color = variable)) +
 geom_line() +
 ggtitle(variable_text) +
 theme(legend.position=c(1, .2)) +
 scale_colour_manual(values=holdnames, labels=legendnames) +
theme(legend.text = element_text(size=10)) + 
  theme(legend.key.size = unit(1, "cm"))
plot_title_1(plot=p1, grtitle=grtitle, footnote=footnote)
```


## Remaining are just examples for reference

## Slide with Plot
```{r room_demand_plot, echo=FALSE, warning=FALSE, dev='CairoPNG'}
#sets variable and text items
todo <- c("totus_demd_sa")
grtitle <- c("Room demand")
footnote <- c("Source: Smith Travel Research, Tourism Economics")

# filters data frame and loads variable text based on code_book_matrix
temp <- filter(ushist_m_m,variable == todo)
variable_text <- code_book_matrix[code_book_matrix$variable_name == 
                                    c("totus_demd_sa"), "variable_text"]
# creates plot
p1 <- ggplot(temp, aes(x = time, y = value, color = variable)) +
  geom_line(size = .9) +
  #scale_color_manual(values = c(mypallete[8:8], "grey80"), 
  #                 labels=c(variable_text, "test")) +
  scale_color_manual(values = c(mypallete[8:8], "grey80")) +
  ggtitle(variable_text) + 
  theme(legend.position="none") #turns off legend
p1 <- p1 + stat_smooth(method="loess")
# adds the title
grobframe <- arrangeGrob(p1, ncol=1, nrow=1,
                         main = textGrob(grtitle, x=0, hjust=0, vjust=0.5, 
                                         gp = gpar(fontsize=16, fontface="bold")),
                         sub = textGrob(footnote, x=0, hjust=0, vjust=0.1, 
                                        gp = gpar(fontface="italic", fontsize=8)))
grid.newpage()
grid.draw(grobframe)
```

## Slide with Plot
```{r room_demand_plot3, echo=FALSE, warning=FALSE, dev='CairoPNG'}
#sets variable and text items
todo <- c("totus_demd_sa")
grtitle <- c("Room demand")
footnote <- c("Source: Smith Travel Research, Tourism Economics")
variable_text <- c("US, demand, average daily in millions, seas. adjusted, \nin log form")
starta <- as.Date("1987-01-01")
enda <- as.Date("2014-10-01")
# filters data frame
temp <- filter(ushist_q_m,variable == todo, time >= starta, time <= enda)
temp <- mutate(temp, value = log(value))

# creates plot
p1 <- ggplot(temp, aes(x = time, y = value, color = variable)) +
  geom_line(size = .9) + colors_ts1 + 
  ggtitle(variable_text) +
  stat_smooth(method="loess")
# adds title
plot_title_1(plot=p1, grtitle=grtitle, footnote=footnote)
```

## Example of filtering to select two variables
```{r room_demand_plot4, echo=FALSE, warning=FALSE, dev='CairoPNG'}
#sets variable and text items
todo <- c("totus_demd_sa")
grtitle <- c("Room demand")
footnote <- c("Source: Smith Travel Research, Tourism Economics")
variable_text <- code_book_matrix[code_book_matrix$variable_name == todo, "variable_text"]
starta <- as.Date("2004-01-01")

# creates plot
temp <- filter(ushist_m_m, variable == todo | variable == "totus_demd", time >= starta) 
p1 <- ggplot(temp, aes(x = time) ) +
  geom_line(aes(y = value, color = variable), size = .9) + 
  colors_ts1 + 
  ggtitle(variable_text)
# titles plot
plot_title_1(plot=p1, grtitle=grtitle, footnote=footnote)
```

## Slide with Plot
Example of selecting two variables using separate dataframe approach
```{r room_demand_plot5, echo=FALSE, warning=FALSE, dev='CairoPNG'}
#sets variable and text items
todo <- c("totus_demd_sa")
grtitle <- c("Room demand")
footnote <- c("Source: Smith Travel Research, Tourism Economics")
variable_text <- code_book_matrix[code_book_matrix$variable_name == todo, "variable_text"]
starta <- as.Date("2004-01-01")

# creates plot
temp <- filter(ushist_m_m, variable == todo, time >= starta) 
temp2 <- filter(ushist_m_m, variable == "totus_demd", time >= starta) 
p1 <- ggplot() +
  geom_line(data = temp, aes(x = time, y = value, color = variable), size = .9) + 
  geom_line(data = temp2, aes(x = time, y = value, color = variable), size = .9) +
  colors_ts1 + 
  ggtitle(variable_text)
plot_title_1(plot=p1, grtitle=grtitle, footnote=footnote)
```

## Slide with Plot
Example of filtering to select one variables
```{r room_demand_plot6, echo=FALSE, warning=FALSE, dev='CairoPNG'}
#sets variable and text items
todo <- c("totus_demd_sa")
grtitle <- c("Room demand")
footnote <- c("Source: Smith Travel Research, Tourism Economics")
variable_text <- code_book_matrix[code_book_matrix$variable_name == todo, "variable_text"]
starta <- as.Date("1987-01-01")

# creates plot
temp <- filter(ushist_m_m, variable == todo, time >= starta) 
p1 <- ggplot(temp, aes(x = time) ) +
  geom_line(aes(y = value, color = variable), size = .9) + 
  colors_ts1 + 
  ggtitle(variable_text) +
  stat_smooth(aes(y=value), method="loess")
# titles plot
plot_title_1(plot=p1, grtitle=grtitle, footnote=footnote)
```

## Slide with Plot
```{r autoplot_example, echo=FALSE, warning=FALSE, dev='CairoPNG'}
temp <- window(ushist_q$totus_demd_sa, end="2014-10-01")
p1 <- autoplot(temp) +
    geom_line(size = .9) +
  scale_color_manual(values = c(mypallete[8:8], "grey80")) +
  ggtitle(variable_text) + 
  theme(legend.position="none") #turns off legend
p1
```

## Slide with Plot
```{r finalexample, dev='CairoPNG'}
autoplot(ushist_q$us_gdp)
```

